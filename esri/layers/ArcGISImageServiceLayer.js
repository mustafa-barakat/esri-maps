// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.38/esri/copyright.txt for details.
//>>built
require({cache:{"esri/layers/ImageServiceLayerMixin":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/json dojo/_base/config dojo/_base/connect dojo/has dojo/io-query dojo/DeferredList ../kernel ../config ../lang ../request ../deferredUtils ../urlUtils ../geometry/Extent ../geometry/Point ../geometry/Polygon ../renderers/colorRampUtils ./MosaicRule ./RasterFunction ./DimensionalDefinition ./Raster ./PixelBlock ./pixelFilters/VectorFieldPixelFilter ./rasterFormats/ImageCanvasDecoder ./TimeInfo ./Field ../graphic ../tasks/ImageServiceIdentifyTask ../tasks/ImageServiceIdentifyParameters".split(" "),
function(J,z,I,e,b,d,g,f,h,n,m,k,q,t,p,x,w,G,M,S,R,O,F,N,K,D,Q,r,v,E,H,B){J=J(null,{declaredClass:"esri.layers.ImageServiceLayerMixin",_rasterFieldPrefix:"Raster.",_renderingRuleFieldSubPrefix:"ServicePixelValue.",_rasterFunctionServiceInfoProps:"bandCount pixelType hasRasterAttributeTable hasColormap hasHistograms minValues maxValues meanValues stdvValues serviceDataType".split(" "),_pixelTypeRanges:{U1:[0,1],U2:[0,3],U4:[0,15],U8:[0,255],S8:[-128,127],U16:[0,65535],S16:[-32768,32767]},_eventMap:{"rendering-change":!0,
"mosaic-rule-change":!0,"spatial-reference-change":!0,"renderer-change":!0},_cachedVariableStats:{},_cachedVariableHistogram:{},constructor:function(a,c){this.useMapTime=c&&c.hasOwnProperty("useMapTime")?!!c.useMapTime:!0},_initialize:function(a,c){this._url=x.urlToObject(a);this.raster=new N(this._url.path);this._rasterFunctionTemplateInfos={};this._customRenderingRuleId={};this.infoTemplate=c&&c.infoTemplate;this.format=(a=c&&c.imageServiceParameters)&&a.format;this.compressionTolerance=a&&a.compressionTolerance?
a.compressionTolerance:.01;this.interpolation=a?a.interpolation:null;this.compressionQuality=a?a.compressionQuality:null;this.bandIds=a?a.bandIds:null;this.mosaicRule=a?a.mosaicRule:null;this.renderingRule=a?a.renderingRule:null;this.renderer=a?a.renderer:null;this.useMapDimensionValue=c&&c.hasOwnProperty("useMapDimensionValue")?!!c.useMapDimensionValue:!0;this.hasImageFilter=c&&c.hasImageFilter;this.activeMapDimensions=c&&c.activeMapDimensions;this._params=z.mixin({},this._url.query,{f:"image",interpolation:this.interpolation,
format:this.format,compressionQuality:this.compressionQuality,bandIds:this.bandIds?this.bandIds.join(","):null},a?a.toJson():{});this.pixelFilter=c&&c.pixelFilter;this.originalPixelData=this.pixelData=null;this.hasDataChanged=!0;this._requestDataHandler=z.hitch(this,this._requestDataHandler);this._requestDataErrorHandler=z.hitch(this,this._requestDataErrorHandler);this._rasterReadPromise=null;this._initLayer=z.hitch(this,this._initLayer);this._queryVisibleRastersHandler=z.hitch(this,this._queryVisibleRastersHandler);
this._visibleRasters=[];this._rasterAttributeTableFields=[];this._rasterAttributeTableFeatures=[];this._renderingRuleAttributeTable={};this._renderingRuleColormap={};this._useRenderingRuleAttributeTable=!1;this._loadCallback=c&&c.loadCallback;a&&a.renderer&&(a.renderer.outputUnit||a.renderer.inputUnit)&&(this.vectorFieldPixelFilter=new D,this.vectorFieldPixelFilter.setUnits(a.renderer.inputUnit,a.renderer.outputUnit));(c=c&&c.resourceInfo)?this._initLayer(c):t({url:this._url.path,content:z.mixin({f:"json"},
this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler});this.registerConnectEvents()},disableClientCaching:!1,_initLayer:function(a,c){if(null!==a&&void 0!==a){this._findCredential();(this.credential&&this.credential.ssl||a&&a._ssl)&&this._useSSL();c=this.minScale;var l=this.maxScale;z.mixin(this,a);this.minScale=c;this.maxScale=l;this.initialExtent=this.fullExtent=this.extent=new w(a.extent);this.spatialReference=this.initialExtent.spatialReference;this.pixelSizeX=
parseFloat(this.pixelSizeX);this.pixelSizeY=parseFloat(this.pixelSizeY);var u=this.minValues,y=this.maxValues,C=this.meanValues,A=this.stdvValues,P=this.bands=[];c=0;for(l=this.bandCount;c<l;c++)P[c]={min:u[c],max:y[c],mean:C[c],stddev:A[c]};this.timeInfo=(c=this.timeInfo)&&c.timeExtent?new r(c):null;l=this.fields=[];if(u=a.fields)for(c=0;c<u.length;c++)l.push(new v(u[c]));this._updateInfoTemplateFields(this.fields);this.version=a.currentVersion;this.version||(this.version="fields"in a||"objectIdField"in
a||"timeInfo"in a?10:9.3);q.isDefined(a.minScale)&&!this._hasMin&&"Raster"!==a.cacheType&&this.setMinScale(a.minScale);q.isDefined(a.maxScale)&&!this._hasMax&&"Raster"!==a.cacheType&&this.setMaxScale(a.maxScale);c={};a.defaultMosaicMethod?(c.method=a.defaultMosaicMethod,c.operation=a.mosaicOperator,c.sortField=a.sortField,c.sortValue=a.sortValue):c.method=R.METHOD_NONE;this.defaultMosaicRule=new R(c);this.defaultMosaicRule.ascending=!0;this._useRenderingRuleAttributeTable=10<this.version&&"esriImageServiceDataTypeThematic"===
this.serviceDataType;this._setDefaultRenderingRule(!0);this._getRenderingRuleAttributeTableAndColormap();this._isScientificData()&&(!this.mosaicRule||this.mosaicRule&&!this.mosaicRule.multidimensionalDefinition)&&this._setDefaultMultidimensionalDefinition(!0);10<this.version&&this.hasRasterAttributeTable&&this.getRasterAttributeTable().then(z.hitch(this,function(L){L&&(L.features&&L.fields&&(this.rasterAttributeTable=z.clone(L)),L.features&&0<L.features.length&&(this._rasterAttributeTableFeatures=
z.clone(L.features)),L.fields&&0<L.fields.length&&(this._rasterAttributeTableFields=z.clone(L.fields)),this.renderingRule||!this.renderer||"esri.renderer.ClassBreaksRenderer"!==this.renderer.declaredClass&&"esri.renderer.UniqueValueRenderer"!==this.renderer.declaredClass||this.refresh())}));this._initVectorPixelFilter();this.bandIds||2!==this.bandCount||this.renderingRule||"esri.layers.ArcGISImageServiceLayer"!==this.declaredClass||this.setBandIds([0,0,0],!0);!(10.3<=this.version&&this.rasterFunctionInfos&&
this.rasterFunctionInfos.length)||this._url.query&&this._url.query.raster||this.getRasterFunctionInfos().then(z.hitch(this,function(L){if(L&&L.length){this.rasterFunctionInfos=L;var W=[],X;e.forEach(L,function(V){if(V){var T=V.functionType;X=X||1===T||2===T;W.push(V.name)}},this);this._hasItemLevelRFT=X;this._rasterFunctionNames=W;X&&(this._initVectorPixelFilter(),this.refresh())}}));this.loaded=!0;this._setDefaultFilter();this.onLoad(this);if(a=this._loadCallback)delete this._loadCallback,a(this)}},
_updateInfoTemplateFields:function(a){if(a&&!(1>a.length)&&this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.fieldInfos&&!(1>this.infoTemplate.info.fieldInfos.length)){var c,l;var u=this.infoTemplate.info.fieldInfos;for(c=0;c<a.length;c++){var y=a[c];for(l=0;l<u.length;l++)if(u[l].fieldName.toLowerCase()===y.name.toLowerCase()&&u[l].fieldName!==y.name){u[l].fieldName=y.name;break}}}},getKeyProperties:function(a){var c=this._url.path+"/keyProperties",l=new I(p._dfdCanceller),u={f:"json"};
a&&a.renderingRule&&(u.renderingRule=b.toJson(a.renderingRule.toJson()));10<this.version?(l._pendingDfd=t({url:c,content:u,handleAs:"json",callbackParamName:"callback"}),l._pendingDfd.then(function(y){l.callback(y)},function(y){l.errback(y)})):(a=Error("Layer does not have key properties"),a.log=!!d.isDebug,l.errback(a));return l},getRasterAttributeTable:function(a){var c=this._url.path+"/rasterAttributeTable",l=new I(p._dfdCanceller),u={f:"json"},y=this.hasRasterAttributeTable;a&&a.renderingRule&&
(u.renderingRule=b.toJson(a.renderingRule.toJson()),y=!0);!this.loaded||10<this.version&&y?(l._pendingDfd=t({url:c,content:u,handleAs:"json",callbackParamName:"callback"}),l._pendingDfd.then(function(C){l.callback(C)},function(C){l.errback(C)})):(a=Error("Layer does not support raster attribute table"),a.log=!!d.isDebug,l.errback(a));return l},getRenderingRuleAttributeTable:function(a){var c=new I(p._dfdCanceller);if(!a||!a.renderingRule)return c.errback(Error("Rendering rule is not specified")),
c;a=a.renderingRule;var l=this._getRenderingRuleId(a);this._renderingRuleAttributeTable&&l&&this._renderingRuleAttributeTable.hasOwnProperty(l)?c.resolve(this._renderingRuleAttributeTable[l]):c=this.getRasterAttributeTable({renderingRule:a}).then(z.hitch(this,function(u){if(u&&u.features&&u.features.length&&u.fields&&u.fields.length){var y={features:z.clone(u.features),fields:z.clone(u.fields)};l&&(this._renderingRuleAttributeTable[l]=y)}return y}));return c},_initVectorPixelFilter:function(){var a;
this._hasItemLevelRFT&&this.renderingRule&&(a=this._getItemLevelRenderingRule(this.renderingRule));if(a=a||this.renderingRule)return this.getRenderingRuleServiceInfo(a).then(z.hitch(this,function(c){!c||!this._isVectorData(c)&&"esri.layers.ArcGISImageServiceVectorLayer"!==this.declaredClass||q.isDefined(this.pixelFilter)||(this.vectorFieldPixelFilter=this.vectorFieldPixelFilter||new D,this.vectorFieldPixelFilter.isDataUV="esriImageServiceDataTypeVector-UV"===c.serviceDataType,this.pixelFilter=this.vectorFieldPixelFilter.computeMagnitudeAndDirection,
this.getKeyProperties().then(z.hitch(this,this._setFlowRepresentation)),this._applyVectorResamplingType(c.serviceDataType))}))},_applyVectorResamplingType:function(a){if(a){var c=this.renderingRule;c&&"Resample"===c.functionName&&((c.functionArguments||{}).ResamplingType="esriImageServiceDataTypeVector-UV"===a?7:10,this.setRenderingRule(new O(c.toJson())))}},_getRasterAttributeTableFeatures:function(){var a=new I;if(this._rasterAttributeTableFeatures&&0<this._rasterAttributeTableFeatures.length)return a.resolve(this._rasterAttributeTableFeatures),
a;if(10<this.version&&this.hasRasterAttributeTable)return a=this.getRasterAttributeTable(),a.then(z.hitch(this,function(c){c&&c.features&&0<c.features.length&&(this._rasterAttributeTableFeatures=z.clone(c.features))})),a;a.resolve(this._rasterAttributeTableFeatures);return a},_getRenderingRuleAttributeTableFeatures:function(a){a=a&&a.renderingRule;return a?this.getRenderingRuleAttributeTable({renderingRule:a}).then(function(c){return c&&c.features}):(a=new I,a.errback(Error("Rendering rule is not specified")),
a)},_getRenderingRuleAttributeTableAndColormap:function(){this.renderingRule&&this.getRenderingRuleServiceInfo(this.renderingRule).then(z.hitch(this,function(a){a.hasRasterAttributeTable&&this.getRenderingRuleAttributeTable({renderingRule:this.renderingRule}).then(z.hitch(this,function(){!this.renderer||"esri.renderer.ClassBreaksRenderer"!==this.renderer.declaredClass&&"esri.renderer.UniqueValueRenderer"!==this.renderer.declaredClass||this.refresh()}));a.hasColormap&&this.getRenderingRuleColormap({renderingRule:this.renderingRule}).then(z.hitch(this,
function(){this.renderer&&"esri.renderer.ColormapRenderer"===this.renderer.declaredClass&&this.refresh()}))}))},getCustomRasterFields:function(a){var c=a?a.rasterAttributeTableFieldPrefix:this._rasterFieldPrefix;a=10.3<=this.version?"esriFieldTypeDouble":"esriFieldTypeString";var l={name:this._rasterFieldPrefix+"ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:a},u={name:this._rasterFieldPrefix+"ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,
length:50,type:a},y={name:this._rasterFieldPrefix+"ServicePixelValue.Raw",alias:"Raw Service Pixel Value",domain:null,editable:!1,length:50,type:"esriFieldTypeDouble"},C=this.fields?z.clone(this.fields):[];a=C.length;C[a]=u;10.4<=this.version&&"esri.layers.ArcGISImageServiceLayer"===this.declaredClass&&(!this.rasterFunctionInfos||!this.rasterFunctionInfos.length||this._isRenderingRuleAProcessingTemplate({functionName:"none"}))&&(a++,C[a]=y);if(this.capabilities&&-1<this.capabilities.toLowerCase().indexOf("catalog")||
this.fields&&0<this.fields.length)a++,C[a]=l;!q.isDefined(this.pixelFilter)||"esriImageServiceDataTypeVector-UV"!==this.serviceDataType&&"esriImageServiceDataTypeVector-MagDir"!==this.serviceDataType||(l={name:this._rasterFieldPrefix+"Magnitude",alias:"Magnitude",domain:null,editable:!1,type:"esriFieldTypeDouble"},u={name:this._rasterFieldPrefix+"Direction",alias:"Direction",domain:null,editable:!1,type:"esriFieldTypeDouble"},a++,C[a]=l,a++,C[a]=u);a=this._rasterAttributeTableFields;(l=this.renderingRule&&
this._getRenderingRuleId(this.renderingRule))&&this._renderingRuleAttributeTable&&this._renderingRuleAttributeTable.hasOwnProperty(l)&&(a=this._renderingRuleAttributeTable[l].fields);a&&0<a.length&&(a=e.filter(a,function(P){return"esriFieldTypeOID"!==P.type&&"value"!==P.name.toLowerCase()}),a=e.map(a,function(P){var L=z.clone(P);L.name=c+P.name;return L}),C=C.concat(a));var A=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;10.4<=this.version&&this.rasterFunctionInfos&&e.forEach(this.rasterFunctionInfos,
function(P){P&&P.name&&"none"!==P.name.toLowerCase()&&(P={name:A+P.name.replace(/ /gi,"_"),alias:P.name,domain:null,editable:!1,type:"esriFieldTypeDouble"},C.push(P))});return C},_applyTimeToMultidimensionalCRF:function(a,c){var l=this._isTimeSupportedOnCRF();if(l&&(!a||!a.multidimensionalDefinition))return a;var u=this.timeInfo&&this.timeInfo.startTimeField;if((c=c||this._params.time)&&u&&this._isMultidimensionalCRF()){a=z.clone(a||this.defaultMosaicRule)||new R;a.multidimensionalDefinition=a.multidimensionalDefinition||
[];var y=a.multidimensionalDefinition.filter(function(A){return A.dimensionName===u}),C=c.split(",").map(function(A){return parseInt(A,10)});2===C.length&&C[0]===C[1]&&(C.length=1);0<y.length?l?a.multidimensionalDefinition.forEach(function(A){A.dimensionName===u&&(A.dimensionName=null,A.isSlice=null,A.values=null)}):a.multidimensionalDefinition.forEach(function(A){A.dimensionName===u&&(A.isSlice=1===C.length,A.values=1===C.length?C:[C])}):l||(a.multidimensionalDefinition.some(function(A){return null!=
A.variableName&&null==A.dimensionName})?a.multidimensionalDefinition.forEach(function(A){null!=A.variableName&&null==A.dimensionName&&(A.dimensionName=u,A.isSlice=1===C.length,A.values=1===C.length?C:[C])}):a.multidimensionalDefinition.push(new F({variableName:"",dimensionName:u,isSlice:1===C.length,values:1===C.length?C:[C]})));this._cleanupMultidimensionalDefinition(a)}return a},_prepareGetImageParameters:function(a,c,l,u){u=q.isDefined(u)?u:this._params;if(this.renderer||this._hasItemLevelRFT&&
this.renderingRule){var y=this.getExportImageRenderingRule();u.renderingRule=y?b.toJson(y.toJson()):null}y=this.getExportImageMosaicRule(u);u.mosaicRule=y?b.toJson(y.toJson()):null;y=a.spatialReference.wkid||b.toJson(a.spatialReference.toJson(!1));delete u._ts;z.mixin(u,{bbox:a.xmin+","+a.ymin+","+a.xmax+","+a.ymax,imageSR:y,bboxSR:y,size:c+","+l},this.disableClientCaching?{_ts:(new Date).getTime()}:{});delete u.compressionTolerance;u.format&&"LERC"===u.format.toUpperCase()&&(u.compressionTolerance=
this.compressionTolerance);u.token=this._getToken()},getImageUrl:function(a,c,l,u,y){y=q.isDefined(y)?y:this._params;this._prepareGetImageParameters(a,c,l,y);a=z.clone(y);this._cleanupRequestParams(a);c=this._url.path+"/exportImage?";l=x.addProxy(c+h.objectToQuery(z.mixin(a,{f:"image"})));var C=a.token;l.length>k.defaults.io.postLength||this.useMapImage?this._jsonRequest=t({url:c,content:z.mixin(a,{f:"json"}),callbackParamName:"callback",load:function(A,P){A=A.href;C&&(A+=-1===A.indexOf("?")?"?token\x3d"+
C:"\x26token\x3d"+C);u(x.addProxy(A))},error:this._errorHandler}):u(l)},onRenderingChange:function(){},onMosaicRuleChange:function(){},onRendererChange:function(){},setInterpolation:function(a,c){this.interpolation=this._params.interpolation=a;c||this.refresh(!0)},setCompressionQuality:function(a,c){this.compressionQuality=this._params.compressionQuality=a;c||this.refresh(!0)},setCompressionTolerance:function(a,c){this.compressionTolerance=a;c||this.refresh(!0)},setBandIds:function(a,c){var l=!1;
this.bandIds!==a&&(l=!0);this.bandIds=a;this._params.bandIds=a?a.join(","):null;if(l&&!c)this.onRenderingChange();c||this.refresh(!0)},setDefaultBandIds:function(a){this.bandIds=this._params.bandIds=null;a||this.refresh(!0)},setDisableClientCaching:function(a){this.disableClientCaching=a},setMosaicRule:function(a,c){var l=!1;this.mosaicRule!==a&&(l=!0);this.mosaicRule=a;this._params.mosaicRule=b.toJson(a.toJson());if(l&&!c)this.onMosaicRuleChange();c||this.refresh(!0)},getRasterFunctionInfos:function(){if(10.3>
this.version||!this.rasterFunctionInfos||!this.rasterFunctionInfos.length)console.log("Layer doesn't support /rasterFunctionInfos resource.");else return t({url:this._url.path+"/rasterFunctionInfos",content:{f:"json"},handleAs:"json",load:function(a){return a&&a.rasterFunctionInfos}})},setRenderingRule:function(a,c){var l=!1;this.renderingRule!==a&&(l=!0);this.renderingRule=a;this._params.renderingRule=a?b.toJson(a.toJson()):null;this._useRenderingRuleAttributeTable?this.getRenderingRuleAttributeTable({renderingRule:a}):
"esri.layers.RasterXLayer"!==this.declaredClass&&this._getRenderingRuleAttributeTableAndColormap();if(l)this.onRenderingChange();this._setDefaultFilter();c||this.refresh(!0)},setImageFormat:function(a,c){this.format=this._params.format=a;this._setDefaultFilter();c||this.refresh(!0)},setInfoTemplate:function(a){this.infoTemplate=a;this._updateInfoTemplateFields(this.fields)},setDefinitionExpression:function(a,c){var l=this.mosaicRule?this.mosaicRule.toJson():{};this.mosaicRule||(this.defaultMosaicRule?
l=this.defaultMosaicRule.toJson():l.method=R.METHOD_NONE);l.where=a;a=new R(l);this.setMosaicRule(a,c);return this},getDefinitionExpression:function(){return this.mosaicRule?this.mosaicRule.where:null},setPixelFilter:function(a){this.pixelFilter=a;this._isDefaultPixelFilter=!1},getPixelData:function(a){return a?(this._useBrowserDecoding()&&(this.originalPixelData={pixelBlock:this._getPixelBlockFromCanvas(this._context,this._map.width,this._map.height),extent:this._map.extent}),this.originalPixelData):
this.pixelData},getExportImageRenderingRule:function(){var a;this._hasItemLevelRFT&&this.renderingRule&&(a=this._getServiceLevelRenderingRule(this.renderingRule));a=a||this.renderingRule;this._isItemLevelRasterFunction(this.renderingRule)&&(a=void 0);return this._combineRenderingRule(this._convertRendererToRenderingRule(this.renderer),a)},getExportImageMosaicRule:function(){var a=this.mosaicRule,c;this._hasItemLevelRFT&&this.renderingRule&&(c=this._getItemLevelRenderingRule(this.renderingRule));c&&
(a=a||this.defaultMosaicRule||new R,a.itemRenderingRule=c);return a=this._applyTimeToMultidimensionalCRF(a)},redraw:function(){this.hasDataChanged=!1;this._setPixelData(this.originalPixelData)},getHistograms:function(a){var c=new I(p._dfdCanceller);if(a&&this._cachedVariableHistogram[a])return c.resolve(this._cachedVariableHistogram[a]),c;if(this.hasHistograms){var l={f:"json"};a&&(l.variable=a);c._pendingDfd=t({url:this._url.path+"/histograms",content:l,handleAs:"json",callbackParamName:"callback"});
c._pendingDfd.then(z.hitch(this,function(u){a&&(this._cachedVariableHistogram[a]=u);c.callback(u)}),function(u){c.errback(u)})}else l=Error("Layer does not have histograms."),l.log=!!d.isDebug,c.errback(l);return c},computeHistograms:function(a){var c=new I(p._dfdCanceller);if(10.1<=this.currentVersion){a=a||{};var l=a.geometry||this.fullExtent,u=(a.geometry||this.fullExtent).toJson();l="extent"===l.type?"esriGeometryEnvelope":"esriGeometryPolygon";var y=a.renderingRule||this.renderingRule||this.defaultRenderingRule;
y=y?y.toJson():null;var C=a.mosaicRule||this.mosaicRule||this.defaultMosaicRule;C=C?C.toJson():null;a=a.pixelSize||{x:this.pixelSizeX,y:this.pixelSizeY};c._pendingDfd=t({url:this._url.path+"/computeHistograms",content:z.mixin({f:"json",geometry:JSON.stringify(u),geometryType:l,renderingRule:JSON.stringify(y),mosaicRule:JSON.stringify(C),pixelSize:JSON.stringify(a),callbackParamName:"callback"}),handleAs:"json"});c._pendingDfd.then(function(A){c.callback(A)},function(A){c.errback(A)})}else u=Error("Layer doesn't support computeHistograms."),
u.log=!!d.isDebug,c.errback(u);return c},getRenderingRuleServiceInfo:function(a,c){function l(C){return C.name&&C.arguments&&C.function&&C.hasOwnProperty("functionType")}var u=new p._fixDfd(new I(p._dfdCanceller));if(!a)return u.errback(Error("Rendering rule is not specified")),u;if(l(a))"ClipFunction"===a.function.type&&(a=this._handleClipFunctionInRenderingRule(a));else{var y=this._getRenderingRuleId(a);if(y&&this._rasterFunctionTemplateInfos[y])return u.resolve(this._rasterFunctionTemplateInfos[y]),
u}return t({url:this._url.path,content:z.mixin(z.mixin({f:"json",renderingRule:JSON.stringify(a.toJson())},this._url.query)),callbackParamName:"callback",load:z.hitch(this,function(C){var A={};e.forEach(this._rasterFunctionServiceInfoProps,function(P){A[P]=C[P]});l(a)||(this._rasterFunctionTemplateInfos[y]=A);return A}),error:c||this._errorHandler})},queryVisibleRasters:function(a,c,l,u){var y=this._map,C=p._fixDfd(new I(p._dfdCanceller));this._visibleRasters=[];var A,P,L=!0,W=!0,X=null,V=this.infoTemplate?
this.infoTemplate.info:null,T=V?z.clone(this.infoTemplate.info.fieldInfos):null;c=c||{};if(V&&this.infoTemplate.info.mediaInfos&&this.infoTemplate.info.mediaInfos.length){var Y=[];e.forEach(this.infoTemplate.info.mediaInfos,function(U){Y=Y.concat(U&&U.value&&U.value.fields||[])});Y.length&&e.forEach(T,function(U){U&&-1<Y.indexOf(U.fieldName)&&(U.visible=!0)})}var ea=function(U){var ja=V&&V.title&&-1<V.title.toLowerCase().indexOf(U.toLowerCase());U=V&&V.description&&-1<V.description.toLowerCase().indexOf(U.toLowerCase());
return ja||U};if(T&&0<T.length)for(L=!1,A=0;A<T.length;A++)if((P=T[A])&&P.fieldName.toLowerCase()!==this._rasterFieldPrefix.toLowerCase()+"servicepixelvalue"&&(P.visible||ea(P.fieldName))){L=!0;break}this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.layerOptions&&this.infoTemplate.info.layerOptions.hasOwnProperty("returnTopmostRaster")&&(X=this.infoTemplate.info.layerOptions.returnTopmostRaster?1:null);T&&0<T.length&&(W=!1,e.some(T,function(U){if(U&&U.fieldName.toLowerCase()===this._rasterFieldPrefix.toLowerCase()+
"itempixelvalue"&&U.visible)return W=!0},this),ea(this._rasterFieldPrefix.toLowerCase()+"itempixelvalue")&&(W=!0));var fa=(P=this._removeVisualizationStretchFunction(this.renderingRule))&&P.functionName,ha=[];if(10.4<=this.version){var aa=!1;if(this.rasterFunctionInfos&&T){var ia=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;e.forEach(this.rasterFunctionInfos,function(U){var ja=ia+U.name.replace(/ /gi,"_");e.some(T,function(qa){return qa.visible&&qa.fieldName===ja})&&(aa=aa||fa&&fa===
U.name,ha.push(new O({rasterFunction:U.name})))})}P&&!aa&&ha.push(P)}A=new B;A.geometry=a.geometry;A.returnGeometry=this._map.spatialReference.equals(this.spatialReference);A.returnCatalogItems=L;A.timeExtent=this.timeInfo?a.timeExtent:null;A.returnPixelValues=W;A.maxItemCount=X||a.maxItemCount;this._params.time&&this.mosaicRule?(a=z.clone(this.mosaicRule),a=this._filterOutTimeDimension(a),A.mosaicRule=a):A.mosaicRule=this.mosaicRule||null;this._isMultidimensionalCRF()&&A.timeExtent&&(A.mosaicRule=
this._applyTimeToMultidimensionalCRF(A.mosaicRule,A.timeExtent.toJson().join(",")),this._isTimeSupportedOnCRF()||delete A.timeExtent);A.renderingRule=10.4>this.version&&P||null;A.renderingRules=ha||null;10.8>this.version&&(A.returnPixelValues=void 0,A.maxItemCount=void 0);y&&(y=new G((y.extent.xmax-y.extent.xmin)/y.width,(y.extent.ymax-y.extent.ymin)/y.height,y.extent.spatialReference),A.pixelSize=y);c.requestParams=A;var Z=this;y=new H(this.url);(C._pendingDfd=y.execute(A)).addCallbacks(function(U){Z._queryVisibleRastersHandler(U,
c,l,u,C)},function(U){Z._resolve([U],null,u,C,!0)});return C},_queryVisibleRastersHandler:function(a,c,l,u,y){function C(){var ba=this.getCustomRasterFields(c),ma=this._getDomainFields(ba),ua=c?c.returnDomainValues:!1,Ba=c&&c.rasterAttributeTableFieldPrefix,ka,va,ra,wa,la,sa,Ca,xa,ya,za;ba=(ba=this._getRenderingRuleId(this.renderingRule))&&this._rasterFunctionTemplateInfos[ba];this.renderingRule&&(this._useRenderingRuleAttributeTable||ba)?(ba=this._getRenderingRuleAttributeTableFeatures({renderingRule:this.renderingRule}),
this.hasRasterAttributeTable||(za=A)):ba=this._getRasterAttributeTableFeatures();ba.then(z.hitch(this,function(Aa){for(ka=0;ka<Z.length;ka++){da=Z[ka];da.setInfoTemplate(this.infoTemplate);da._layer=this;if(A){ya=A.replace(/ /gi,"").split(",");va=A;ra=ya;U&&U.length>=ka&&(va=U[ka].replace(/ /gi,", "),ra=U[ka].split(" "));da.attributes[this._rasterFieldPrefix+"ItemPixelValue"]=ra;da.attributes[this._rasterFieldPrefix+"ServicePixelValue"]=ya;P&&(da.attributes[this._rasterFieldPrefix+"ServicePixelValue.Raw"]=
P.replace(/ /gi,"").split(","));if(this.pixelFilter){var ta=new K({height:1,width:1,pixelType:"F32",pixels:[],statistics:[]});e.forEach(ra,function(ca){ta.addData({pixels:[ca],statistics:{minValue:ca,maxValue:ca,noDataValue:null}})});this.pixelFilter({pixelBlock:ta,extent:new w(0,0,0,0,this._map.spatialReference)});if("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)da.attributes[this._rasterFieldPrefix+"Magnitude"]=ta.pixels[0][0],
da.attributes[this._rasterFieldPrefix+"Direction"]=ta.pixels[1][0]}e.forEach(T,function(ca){da.attributes[ca.name]=ca.value});var Da=0<this.fields.length?za||va:za||P;if(Aa&&0<Aa.length&&(wa=e.filter(Aa,function(ca){if(ca&&ca.attributes)return ca.attributes.hasOwnProperty("Value")?ca.attributes.Value==Da:ca.attributes.VALUE==Da}),0<wa.length&&(la=z.clone(wa[0]),Ba&&la))){xa={};for(sa in la.attributes)la.attributes.hasOwnProperty(sa)&&(Ca=Ba+sa,xa[Ca]=la.attributes[sa]);la.attributes=xa;da.attributes=
z.mixin(da.attributes,la.attributes)}}ua&&ma&&0<ma.length&&e.forEach(ma,function(ca){if(ca){var na=da.attributes[ca.name];q.isDefined(na)&&(na=this._getDomainValue(ca.domain,na),q.isDefined(na)&&(da.attributes[ca.name]=na))}},this);oa.push(da);this._visibleRasters.push(da)}this._resolve([oa,null,!0],null,l,y)}))}var A=a.value,P=a.value,L=0,W=0,X=this,V=this.objectIdField,T=[];u=c.requestParams.renderingRules;var Y=a.processedValues,ea=this.renderingRule&&b.toJson(this._removeVisualizationStretchFunction(this.renderingRule).toJson());
if(u&&Y&&u.length===Y.length){var fa=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;e.forEach(u,function(ba,ma){if(ba.functionName){var ua={name:fa+ba.functionName.replace(/ /gi,"_"),value:Y[ma].replace(/ /gi,"").split(",")};T.push(ua);ea&&ea===b.toJson(ba.toJson())&&(A=Y[ma])}})}u=this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.layerOptions&&this.infoTemplate.info.layerOptions.hasOwnProperty("showNoDataRecords")?this.infoTemplate.info.layerOptions.showNoDataRecords:!0;
if(a.catalogItems){var ha=0,aa=a.catalogItems.features.length;var ia=0;var Z=Array(aa);var U=Array(aa);var ja=Array(aa);if(a.properties&&a.properties.Values){aa=a.properties.Values.length;for(L=0;L<aa;L++)-1<a.properties.Values[L].toLowerCase().indexOf("nodata")&&ia++;var qa=aa-ia;for(L=0;L<aa;L++){ia=!0;if(-1<a.properties.Values[L].toLowerCase().indexOf("nodata")){var pa=qa++;u||(ia=!1,Z.length--,U.length--,ja.length--)}else pa=ha++;ia&&(Z[pa]=a.catalogItems.features[L],U[pa]=a.properties.Values[L],
ja[pa]=Z[pa].attributes[V])}}else{for(L=0;L<aa;L++)Z[L]=a.catalogItems.features[L],ja[L]=Z[L].attributes[V];U=null}}this._visibleRasters=[];(a=-1<A.toLowerCase().indexOf("nodata"))&&!u&&(Z=[],U=[],ja=[]);if(A&&!Z&&!a){V="ObjectId";Z=[];var da=new E(new w(this.fullExtent),null,{ObjectId:0});Z.push(da)}var oa=[];Z?!this._map.spatialReference.equals(this.spatialReference)&&ja&&0<ja.length?t({url:this._url.path+"/query",content:{f:"json",objectIds:ja.join(","),returnGeometry:!0,outSR:b.toJson(X._map.spatialReference.toJson()),
outFields:V},handleAs:"json",callbackParamName:"callback",load:function(ba){if(0===ba.features.length)X._resolve([oa,null,null],null,l,y);else{for(L=0;L<ba.features.length;L++)for(W=0;W<Z.length;W++)Z[W].attributes[V]==ba.features[L].attributes[V]&&(Z[W].geometry=new M(ba.features[L].geometry),Z[W].geometry.setSpatialReference(X._map.spatialReference));C.call(X)}},error:function(ba){X._resolve([oa,null,null],null,l,y)}}):C.call(this):this._resolve([oa,null,null],null,l,y)},getVisibleRasters:function(){var a=
this._visibleRasters,c=[],l;for(l in a)a.hasOwnProperty(l)&&c.push(a[l]);return c},_getDomainFields:function(a){if(a){var c=[];e.forEach(a,function(l){if(l.domain){var u={};u.name=l.name;u.domain=l.domain;c.push(u)}});return c}},_getDomainValue:function(a,c){if(a&&a.codedValues){var l;e.some(a.codedValues,function(u){return u.code===c?(l=u.name,!0):!1});return l}},_requestData:function(a,c,l){this._rasterReadPromise&&this._rasterReadPromise.cancel();a=z.clone(a);var u=a._normalize(!0);this._prepareGetImageParameters(u,
c,l);c=z.clone(this._params);this._cleanupRequestParams(c);c.extent=a;c.format=c.format||(10.3<=this.version?"lerc":"jpgpng");"lerc"===c.format.toLowerCase()&&!c.lercVersion&&10.5<=this.version&&(c.lercVersion=2);this._params.time&&this._isMultidimensionalCRF()&&!this._isTimeSupportedOnCRF()&&delete c.time;l=null;this._useBrowserDecoding()&&(l=new Q({ctx:this._context}));c={imageServiceParameters:c,nBands:Math.min(this.bandCount,3),pixelType:this.pixelType,decodeFunc:l?z.hitch(l,"decode"):null};this._rasterReadPromise=
this.raster.read(c,this._requestDataHandler,this._requestDataErrorHandler)},_requestDataHandler:function(a){this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this.originalPixelData=a,this.hasDataChanged=!0,this._setPixelData(a))},_setPixelData:function(a){a=this._clonePixelData(a);this.pixelFilter&&this.pixelFilter(a);this.pixelData=a;this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this._drawPixelData(),this._rasterReadPromise=null)},_clonePixelData:function(a){if(null===
a||void 0===a)return a;var c={};a.extent&&(c.extent=z.clone(a.extent));a=a.pixelBlock;if(null===a||void 0===a)return c;c.pixelBlock=a.clone();return c},_setDefaultFilter:function(){},_getPixelBlockFromCanvas:function(a,c,l){a=a.getImageData(0,0,c,l).data;var u=c*l,y=0,C=0,A=new Uint8Array(u),P=new Uint8Array(u),L=new Uint8Array(u),W=new Uint8Array(u),X=Infinity,V=Infinity,T=Infinity,Y=-Infinity,ea=-Infinity,fa=-Infinity;for(y=0;y<u;y++){var ha=a[C++];var aa=a[C++];var ia=a[C++];X=X<ha?X:ha;Y=Y>ha?
Y:ha;V=V<aa?V:aa;ea=ea>aa?ea:aa;T=T<ia?T:ia;fa=fa>ia?fa:ia;A[y]=ha;P[y]=aa;L[y]=ia;W[y]=a[C++]&1}return new K({width:c,height:l,pixels:[A,P,L],pixelType:"U8",mask:W,statistics:[{minValue:X,maxValue:Y},{minValue:V,maxValue:ea},{minValue:T,maxValue:fa}]})},_useBrowserDecoding:function(){return(void 0===this.pixelFilter||null===this.pixelFilter)&&("jpeg"===this.format.toLowerCase()||"jpg"===this.format.toLowerCase()||-1<this.format.toLowerCase().indexOf("png"))},getMultidimensionalInfo:function(){var a=
this._url.path+"/multiDimensionalInfo",c=new I(p._dfdCanceller);if(this._multidimensionalInfo)return c.resolve(this._multidimensionalInfo),c;!this.loaded||10.3<=this.version&&this.hasMultidimensions?(c._pendingDfd=t({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),c._pendingDfd.then(z.hitch(this,function(l){this._multidimensionalInfo=l.multidimensionalInfo;c.callback(l.multidimensionalInfo)}),function(l){c.errback(l)})):(a=Error("Layer does not support multidimensional info"),
a.log=!!d.isDebug,c.errback(a));return c},getStatistics:function(a){var c=new I(p._dfdCanceller);if(a&&this._cachedVariableStats[a])c.resolve(this._cachedVariableStats[a]);else{var l={f:"json"};a&&(l.variable=a);c._pendingDfd=t({url:this._url.path+"/statistics",content:l,handleAs:"json",callbackParamName:"callback"});c._pendingDfd.then(z.hitch(this,function(u){u=u.statistics||u.statitsics;var y=[];u&&u[0]&&null!=u[0].min?u.forEach(function(C){y.push([C.min,C.max,C.mean,C.standardDeviation])}):y=this.minValues&&
this.minValues.length?this.minValues.map(function(C,A){return[C,this.maxValues[A],this.meanValues[A],this.stdvValues[A]]}.bind(this)):u;a&&(this._cachedVariableStats[a]=y);c.callback(y)}),function(u){c.errback(u)})}return c},getDefaultMultidimensionalDefinition:function(){var a=new I(p._dfdCanceller);if(this._defaultMultidimensionalDefinition)return a.resolve(z.clone(this._defaultMultidimensionalDefinition)),a;a._pendingDfd=this.getMultidimensionalInfo();a._pendingDfd.then(z.hitch(this,function(c){c=
this._getDefaultMultidimensionalDefinition(c);a.callback(c)}),function(c){a.errback(c)});return a},_getDefaultMultidimensionalDefinition:function(a,c,l){var u,y=[],C=this.defaultVariable||"",A=C.length?a.variables.filter(function(P){return P.name===C})[0].dimensions:a.variables[0].dimensions;l&&(C=this.defaultVariable||a.variables[0].name);for(u in A)A.hasOwnProperty(u)&&(c||"StdTime"!==A[u].name)&&(a=A[u],y.push(new F({variableName:C,dimensionName:a.name,isSlice:!a.hasRanges,values:[this._getDefaultDimensionValue(a)]})));
this._defaultMultidimensionalDefinition=y;return z.clone(y)},_getDefaultDimensionValue:function(a){if(a&&a.values&&a.values.length){var c=Infinity,l;if(a.hasRanges)return a.values[0];if(a.name&&"stdz"===a.name.toLowerCase()){for(l=0;l<a.values.length;l++){var u=a.values[l];var y=Math.abs(u-0);if(y<c){c=y;var C=u}if(0===y)break}return C}return a.extent[0]}},_setDefaultMultidimensionalDefinition:function(a){var c,l={};this.getDefaultMultidimensionalDefinition().then(z.hitch(this,function(u){c=u;0<c.length&&
(this.mosaicRule?(l=z.clone(this.mosaicRule),l.multidimensionalDefinition=c):this.defaultMosaicRule?(l=z.clone(this.defaultMosaicRule),l.multidimensionalDefinition=c):l=new R({multidimensionalDefinition:c}),this.setMosaicRule(l,a))}))},_setDefaultRenderingRule:function(a){var c={},l=this.renderingRule;if(!l&&"esri.layers.ArcGISImageServiceVectorLayer"!==this.declaredClass&&!this.bandIds&&this.rasterFunctionInfos&&this.rasterFunctionInfos.length&&"none"!==this.rasterFunctionInfos[0].name.toLowerCase())c.rasterFunction=
this.rasterFunctionInfos[0].name;else if("esri.layers.ArcGISImageServiceVectorLayer"===this.declaredClass&&10.3<this.version&&(!l||"Resample"!==l.functionName)){var u="esriImageServiceDataTypeVector-UV"===this.serviceDataType?7:10;c.rasterFunction="Resample";c.rasterFunctionArguments={ResamplingType:u,InputCellSize:{x:this.pixelSizeX,y:this.pixelSizeY}};l&&(c.rasterFunctionArguments.Raster=l.toJson())}c.hasOwnProperty("rasterFunction")&&(this.defaultRenderingRule=new O(c),this.setRenderingRule(this.defaultRenderingRule,
a))},_cleanupRequestParams:function(a){if(!a)return a;if(a.time&&a.mosaicRule){var c=new R(b.fromJson(a.mosaicRule));c=this._filterOutTimeDimension(c);a.mosaicRule=b.toJson(c.toJson())}c="displayOnPan drawMode styling id opacity visible resourceInfo useMapDimensionValue extent renderer".split(" ");for(var l in c)a.hasOwnProperty(c[l])&&delete a[c[l]];return a},_filterOutTimeDimension:function(a){if(this._isMultidimensionalCRF())return a;if(a&&a.multidimensionalDefinition&&0<a.multidimensionalDefinition.length){var c=
e.filter(a.multidimensionalDefinition,function(l){return"StdTime"!==l.dimensionName});a.multidimensionalDefinition=c}return a},_removeVisualizationStretchFunction:function(a){var c=a&&a.functionName;if(!c||"stretch"!==c.toLowerCase())return a;var l=a.functionArguments.Raster;return l&&l.functionName&&e.some(this.rasterFunctionInfos,function(u){return l.functionName===u.name})?l:a},_isMultidimensionalCRF:function(){return 10.71<=this.version&&this.hasMultidimensions&&this.timeInfo&&!(this.objectIdField&&
this.fields&&1<this.fields.length)},_isTimeSupportedOnCRF:function(){return 10.8<=this.version},_cleanupMultidimensionalDefinition:function(a){a&&a.multidimensionalDefinition&&(a.multidimensionalDefinition=a.multidimensionalDefinition.filter(function(c){return!(!c.variableName&&!c.dimensionName)}),0===a.multidimensionalDefinition.length&&(a.multidimensionalDefinition=null))},_isScientificData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===
this.serviceDataType||"esriImageServiceDataTypeScientific"===this.serviceDataType||this.hasMultidimensions},_isVectorData:function(a){a=(a=a||this)&&a.serviceDataType;return"esriImageServiceDataTypeVector-UV"===a||"esriImageServiceDataTypeVector-MagDir"===a},_isRenderingRuleAProcessingTemplate:function(a){var c=a&&a.functionName;return!c||a.functionArguments?!1:e.some(c&&(this.rasterFunctionInfos||[]),function(l){return l&&l.name&&l.name.toLowerCase()===c.toLowerCase()})},_getRenderingRuleId:function(a){var c=
a&&a.functionName;if(c){if(this._isRenderingRuleAProcessingTemplate(a))return c;var l=this._customRenderingRuleId[c];if(l){if(l!==a){for(var u in this._customRenderingRuleId)if(this._customRenderingRuleId[u]===a)return u;for(l=0;this._customRenderingRuleId[y];)l+=1;var y;this._customRenderingRuleId[c+l]=a}}else this._customRenderingRuleId[c]=a;return c}},_createPixelData:function(a){a=new K({width:2,height:2,pixels:a,pixelType:this.pixelType,statistics:a});var c=this.fullExtent.getCenter();c=new w(c.x,
c.y,c.x+this.pixelSizeX,c.y+this.pixelSizeY,this.spatialReference);return{pixelBlock:a,extent:c}},_convertRendererToRenderingRule:function(a){var c=a&&a.declaredClass;if(!c||"esri.renderer.UniqueValueRenderer"!==c&&"esri.renderer.ClassBreaksRenderer"!==c&&"esri.renderer.StretchRenderer"!==c&&"esri.renderer.ShadedReliefRenderer"!==c&&"esri.renderer.ColormapRenderer"!==c)return null;var l=null;"esri.renderer.StretchRenderer"===c?l=a.toRenderingRule({convertToColormap:10.6>this.version}):"esri.renderer.ClassBreaksRenderer"===
c?l=this._convertClassifyRenderer(a):"esri.renderer.UniqueValueRenderer"===c?l=this._convertUniqueValueRenderer(a):"esri.renderer.ShadedReliefRenderer"===c?l=this._convertShadedReliefRenderer(a):"esri.renderer.ColormapRenderer"===c&&(l=this._convertColormapRenderer(a));return l},_getValueField:function(a){if(a&&a.length){var c,l;e.some(a,function(u){if((l=u.name)&&"value"===l.toLowerCase())return c=l,!0});return c}},_convertColormapRenderer:function(a){var c=new O;c.functionName="Colormap";c.functionArguments=
{};a=a.colormapInfos.map(function(l){return[l.value].concat(l.color)});c.functionArguments.Colormap=a;return c},_convertShadedReliefRenderer:function(a){var c=new O;c.functionName="Hillshade";var l="traditional"===a.hillshadeType?0:1,u="none"===a.scalingType?1:3,y={HillshadeType:l,SlopeType:u,ZFactor:a.zFactor};0===l&&(y.Azimuth=a.azimuth,y.Altitude=a.altitude);3===u&&(y.PSPower=a.pixelSizePower,y.PSZFactor=a.pixelSizeFactor);c.functionArguments=y;c.variableName="Raster";a.colorRamp&&(c.functionName=
"ShadedRelief",y.Colormap=S.convertColorRampToColormap(a.colorRamp,256));return c},_convertClassifyRenderer:function(a){var c=[],l=[],u=[],y=[],C;var A=this.renderingRule&&this._getRenderingRuleId(this.renderingRule);var P=this.hasRasterAttributeTable;if(A){P=this._rasterFunctionTemplateInfos[A]?this._rasterFunctionTemplateInfos[A].hasRasterAttributeTable:this.hasRasterAttributeTable;var L=this._renderingRuleAttributeTable[A];var W=this._rasterFunctionTemplateInfos[A]}var X=L&&L.features?L.features:
this._rasterAttributeTableFeatures;var V=this._getValueField(L&&L.fields?L.fields:this._rasterAttributeTableFields);P&&X?(e.forEach(a.infos,function(T,Y){var ea,fa=T.symbol.color;fa.a&&e.forEach(X,function(ha){ea=ha.attributes[a.attributeField];(ea>=T.minValue&&ea<T.maxValue||Y===a.infos.length-1&&ea>=T.minValue)&&y.push([ha.attributes[V],fa.r,fa.g,fa.b])},this)},this),A=W&&W.pixelType||this.pixelType,this._adjustColormapToPixelTypeRange(y,A),A=new O,A.functionName="Colormap",A.functionArguments=
{},A.functionArguments.Colormap=y,A.variableName="Raster"):(e.forEach(a.infos,function(T,Y){C=T.symbol&&T.symbol.color;C.a?(0===Y?c.push.call(c,T.minValue,T.maxValue+1E-4):c.push.call(c,T.minValue+1E-4,T.maxValue+1E-4),l.push(Y),y.push([Y,C.r,C.g,C.b])):u.push(T.minValue,T.maxValue)}),A=W&&W.pixelType||this.pixelType,this._adjustColormapToPixelTypeRange(y,A),A=new O,A.functionName="Remap",A.functionArguments={InputRanges:c,OutputValues:l,NoDataRanges:u},A.variableName="Raster",L=new O,L.functionName=
"Colormap",L.functionArguments={Colormap:y,Raster:A},A=L);return A},_convertUniqueValueRenderer:function(a){var c=[],l=this.renderingRule&&this._getRenderingRuleId(this.renderingRule);if(l){var u=this._renderingRuleAttributeTable[l];var y=this._rasterFunctionTemplateInfos[l]}var C=u&&u.features?u.features:this._rasterAttributeTableFeatures;var A=(l=u&&u.fields?u.fields:this._rasterAttributeTableFields)&&l.length?this._getValueField(l):"Value";e.forEach(a.infos,function(P){var L=P.symbol.color;L.a&&
(a.attributeField!==A&&C?e.forEach(C,function(W){W.attributes[a.attributeField]==P.value&&c.push([W.attributes[A],L.r,L.g,L.b])},this):c.push([P.value,L.r,L.g,L.b]))},this);this._adjustColormapToPixelTypeRange(c,y&&y.pixelType||this.pixelType);y=new O;y.functionName="Colormap";y.functionArguments={};y.functionArguments.Colormap=c;y.variableName="Raster";return y},_adjustColormapToPixelTypeRange:function(a,c){(c=this._pixelTypeRanges[c])&&a.push([Math.floor(c[0]-1),0,0,0],[Math.ceil(c[1]+1),0,0,0]);
return a},_combineRenderingRule:function(a,c){if(!a||!c)return a||c;var l=function(u){var y=u.Raster;return y=y&&"esri.layers.RasterFunction"===y.declaredClass?l(y.functionArguments):u};a=z.clone(a);"none"!==c.functionName.toLocaleLowerCase()&&(l(a.functionArguments).Raster=c);return a},_isItemLevelRasterFunction:function(a){var c=a&&a.functionName;if(!c||!this._hasItemLevelRFT)return!1;var l=!1;e.some(this.rasterFunctionInfos,function(u){if(u&&u.name===c){if(1===u.functionType||2===u.functionType)l=
!0;return!0}});return l},_getServiceLevelRenderingRule:function(a){if(!this._hasItemLevelRFT||!a)return a;a=new O(a.toJson());var c=a.functionArguments;for(var l;;)if((l=c&&c.Raster)&&l.functionArguments&&l.functionArguments.Raster)c=l,c=c.functionArguments;else{this._isItemLevelRasterFunction(l)&&delete c.Raster;break}return a},_getItemLevelRenderingRule:function(a){if(!this._hasItemLevelRFT||!a)return null;if(this._isItemLevelRasterFunction(a))return a;a=new O(a.toJson());for(a=a.functionArguments;;)if((a=
a&&a.Raster)&&a.functionArguments&&a.functionArguments.Raster)a=a.functionArguments;else{if(this._isItemLevelRasterFunction(a))return a;break}},_resolve:function(a,c,l,u,y){c&&this[c].apply(this,a);l&&l.apply(null,a);u&&p._resDfd(u,a,y)},_toggleTime:function(){var a=this._map;this.timeInfo&&this.useMapTime&&a&&!this.suspended?(this._timeConnect||(this._timeConnect=g.connect(a,"onTimeExtentChange",this,this._onTimeExtentChangeHandler)),this._setTime(a.timeExtent)):(g.disconnect(this._timeConnect),
this._timeConnect=null,this._setTime(null))},setUseMapTime:function(a,c){this.useMapTime=a;this._toggleTime();!c&&this._map&&this.refresh(!0)},_setTime:function(a){this._params&&(this._params.time=a?a.toJson().join(","):null)},_onTimeExtentChangeHandler:function(a){this.suspended||(this._setTime(a),this.refresh(!0))},handleSpatialReferenceChange:function(){this.onSpatialReferenceChange()},getColormap:function(a){var c=this._url.path+"/colormap",l=new I(p._dfdCanceller),u={f:"json"};a&&a.renderingRule&&
(u.renderingRule=b.toJson(a.renderingRule.toJson()));this.hasColormap?(l._pendingDfd=t({url:c,content:u,handleAs:"json",callbackParamName:"callback"}),l._pendingDfd.then(function(y){l.callback(y)},function(y){l.errback(y)})):(a=Error("Layer does not support colormap"),a.log=!!d.isDebug,l.errback(a));return l},getRenderingRuleColormap:function(a){var c=new I(p._dfdCanceller);if(!a||!a.renderingRule)return c.errback(Error("Rendering rule is not specified")),c;a=a.renderingRule;var l=this._getRenderingRuleId(a);
this._renderingRuleColormap&&l&&this._renderingRuleColormap.hasOwnProperty(l)?c.resolve(this._renderingRuleColormap[l]):c=this.getColormap({renderingRule:a}).then(z.hitch(this,function(u){u=u&&u.colormap;l&&(this._renderingRuleColormap[l]=u);return u}));return c},_handleClipFunctionInRenderingRule:function(a){a=z.clone(a);var c=a.arguments,l=c.ClippingGeometry&&c.ClippingGeometry.value,u=c.Extent&&c.Extent.value;c.ClippingRaster&&c.ClippingRaster.value||l||u||(c=this._map.extent.toJson(),a.arguments.Extent.value=
c,a.functionArguments.Extent.value=c,a._isTemplate&&(a._templateJson.arguments.Extent.value=c));return a}});f("extend-esri")&&z.setObject("layers.ImageServiceLayerMixin",J,m);return J})},"dojo/DeferredList":function(){define(["./_base/kernel","./_base/Deferred","./_base/array"],function(J,z,I){J.DeferredList=function(e,b,d,g,f){var h=[];z.call(this);var n=this;0!==e.length||b||this.resolve([0,[]]);var m=0;I.forEach(e,function(k,q){function t(p,x){h[q]=[p,x];m++;m===e.length&&n.resolve(h)}k.then(function(p){b?
n.resolve([q,p]):t(!0,p)},function(p){d?n.reject(p):t(!1,p);if(g)return null;throw p;})})};J.DeferredList.prototype=new z;J.DeferredList.prototype.gatherResults=function(e){e=new J.DeferredList(e,!1,!0,!1);e.addCallback(function(b){var d=[];I.forEach(b,function(g){d.push(g[1])});return d});return e};return J.DeferredList})},"esri/layers/MosaicRule":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../lang ../geometry/Point ./RasterFunction".split(" "),function(J,z,I,e,b,d,g){var f=
J(null,{declaredClass:"esri.layers.MosaicRule",method:null,where:null,sortField:null,sortValue:null,ascending:!1,lockRasterIds:null,viewpoint:null,objectIds:null,operation:null,multidimensionalDefinition:[],itemRenderingRule:null,constructor:function(h){z.isObject(h)&&(z.mixin(this,h),h.mosaicMethod&&(this.method=h.mosaicMethod),this.method&&"esri"!==this.method.toLowerCase().substring(0,4)&&(this.method=this._getMethodEnum(this.method)),h.mosaicOperation&&(this.operation=h.mosaicOperation),this.operation&&
"MT_"!==this.operation.toUpperCase().substring(0,3)&&(this.operation=this._getOperatorEnum(this.operation)),h.fids&&(this.objectIds=h.fids),h.viewpoint&&(this.viewpoint=new d(h.viewpoint)),h.itemRenderingRule&&(this.itemRenderingRule=new g(h.itemRenderingRule)),this.multidimensionalDefinition=h.multidimensionalDefinition||[])},toJson:function(){var h=null,n=this.multidimensionalDefinition?this.multidimensionalDefinition.length:0;if(n){h=[];for(var m=0;m<n;m++)h.push("esri.layers.DimensionalDefinition"===
this.multidimensionalDefinition[m].declaredClass?this.multidimensionalDefinition[m].toJson():this.multidimensionalDefinition[m])}h={mosaicMethod:this.method,where:this.where,sortField:this.sortField,sortValue:this.sortValue,ascending:this.ascending,lockRasterIds:z.clone(this.lockRasterIds),viewpoint:this.viewpoint?this.viewpoint.toJson():null,fids:z.clone(this.objectIds),mosaicOperation:this.operation,multidimensionalDefinition:h,itemRenderingRule:this.itemRenderingRule?this.itemRenderingRule.toJson():
null};return b.filter(h,function(k){if(null!==k)return!0})},_getMethodEnum:function(h){if(h){var n=f.METHOD_NONE;switch(h.toLowerCase()){case "byattribute":n=f.METHOD_ATTRIBUTE;break;case "center":n=f.METHOD_CENTER;break;case "lockraster":n=f.METHOD_LOCKRASTER;break;case "nadir":n=f.METHOD_NADIR;break;case "northwest":n=f.METHOD_NORTHWEST;break;case "seamline":n=f.METHOD_SEAMLINE;break;case "viewpoint":n=f.METHOD_VIEWPOINT}return n}},_getOperatorEnum:function(h){if(h)switch(h.toLowerCase()){case "first":return f.OPERATION_FIRST;
case "last":return f.OPERATION_LAST;case "max":return f.OPERATION_MAX;case "min":return f.OPERATION_MIN;case "blend":return f.OPERATION_BLEND;case "mean":return f.OPERATION_MEAN;case "sum":return f.OPERATION_SUM}}});z.mixin(f,{METHOD_NONE:"esriMosaicNone",METHOD_CENTER:"esriMosaicCenter",METHOD_NADIR:"esriMosaicNadir",METHOD_VIEWPOINT:"esriMosaicViewpoint",METHOD_ATTRIBUTE:"esriMosaicAttribute",METHOD_LOCKRASTER:"esriMosaicLockRaster",METHOD_NORTHWEST:"esriMosaicNorthwest",METHOD_SEAMLINE:"esriMosaicSeamline",
OPERATION_FIRST:"MT_FIRST",OPERATION_LAST:"MT_LAST",OPERATION_MIN:"MT_MIN",OPERATION_MAX:"MT_MAX",OPERATION_MEAN:"MT_MEAN",OPERATION_BLEND:"MT_BLEND",OPERATION_SUM:"MT_SUM"});I("extend-esri")&&z.setObject("layers.MosaicRule",f,e);return f})},"esri/layers/DimensionalDefinition":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel","../lang"],function(J,z,I,e,b){J=J(null,{declaredClass:"esri.layers.DimensionalDefinition",variableName:null,dimensionName:null,values:[],isSlice:!1,
constructor:function(d){z.isObject(d)&&z.mixin(this,d)},toJson:function(){var d={variableName:this.variableName,dimensionName:this.dimensionName,values:z.clone(this.values),isSlice:this.isSlice};return b.filter(d,function(g){return null!==g})}});I("extend-esri")&&z.setObject("layers.DimensionalDefinition",J,e);return J})},"esri/layers/Raster":function(){define("require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/config dojo/json dojo/sniff ../kernel ../Evented ../request ../geometry/Extent ../SpatialReference ../deferredUtils ./PixelBlock ./rasterFormats/LercCodec ./rasterFormats/Lerc2Codec".split(" "),
function(J,z,I,e,b,d,g,f,h,n,m,k,q,t,p,x,w){var G,M,S,R,O,F;z=z(n,{declaredClass:"esri.layers.Raster",imageServiceUrl:null,validPixelTypes:"U1 U2 U4 U8 U16 U32 S8 S16 S32 F32".split(" "),validFormats:"lerc jpeg jpg jpgpng png png8 png24 png32 bip bsq tiff".split(" "),_eventMap:{"raster-read-complete":["pixelData","params"]},constructor:function(r){this.imageServiceUrl=r;this.registerConnectEvents();this._loadRasterFormatModules()},read:function(r,v,E){var H=this,B=new e(t._dfdCanceller);if(10>f("ie"))throw"This browser is not supported.";
if(!r.imageServiceParameters)throw"Insufficient parameters to read data";var a=I.clone(r.imageServiceParameters),c=r.pixelType;b.some(this.validPixelTypes,function(P){return P===c})||(a.pixelType="F32");b.some(this.validFormats,function(P){return P.toLowerCase()===a.format.toLowerCase()})||(a.format="lerc");var l=r.decodeFunc,u;this._prepareGetImageParameters(a);var y=a.width,C=a.height,A=a.extent;delete a.width;delete a.height;delete a.extent;B._pendingDfd=m({url:this.imageServiceUrl+"/exportImage",
handleAs:"arraybuffer",content:I.mixin(a,{f:"image"}),load:function(P){H.decode(P,{width:y,height:C,planes:null,pixelType:c,noDataValue:a.noData,format:a.format,decodeFunc:l}).then(function(L){u={pixelBlock:L,extent:A};H._resolve([u,a],"onRasterReadComplete",v,B)},function(L){H._resolve([L],null,E,B,!0)})},error:function(P){H._resolve([P],null,E,B,!0)}});return B.promise},decode:function(r,v){if(void 0===v||null===v)throw"missing decode options";var E;v.format&&(E=v.format.toUpperCase());"BSQ"!==
E&&"BIP"!==E&&(E=this._getFormat(r));var H=v.decodeFunc;if(void 0===H||null===H)H=this._getFormatDecoderDfd(E);return H(r,v)},onRasterReadComplete:function(){},_prepareGetImageParameters:function(r){if(r.size&&r.bbox){var v=r.size.split(",");r.width=parseFloat(v[0]);r.height=parseFloat(v[1]);r.extent||(v=r.bbox.split(","),r.extent=new k(parseFloat(v[0]),parseFloat(v[1]),parseFloat(v[2]),parseFloat(v[3]),new q(r.bboxSR)))}else{if(!r.width||Math.floor(r.width)!==r.width||!r.height||Math.floor(r.height)!==
r.height)throw"Incorrect Image Dimensions";if(!r.extent||"esri.geometry.Extent"!==r.extent.declaredClass)throw"Incorrect extent";v=r.extent;var E=v.spatialReference.wkid||g.toJson(v.spatialReference.toJson());delete r._ts;I.mixin(r,{bbox:v.xmin+","+v.ymin+","+v.xmax+","+v.ymax,imageSR:E,bboxSR:E,size:r.width+","+r.height},r.disableClientCaching?{_ts:(new Date).getTime()}:{})}},_adjustExtent:function(r,v,E){var H=r.ymax-r.ymin,B=r.xmax-r.xmin;E>=v?r.ymax=r.ymin+B*v/E:r.xmax=r.xmin+H*E/v;return r},
_resolve:function(r,v,E,H,B){v&&this[v].apply(this,r);E&&E.apply(null,r);H&&t._resDfd(H,r,B)},_getFormatDecoderDfd:function(r){var v=null;switch(r){case "LERC":v=this._decodeLerc;break;case "LERC2":v=this._decodeLerc2;break;case "JPEG":v=this._decodeJpeg;break;case "PNG":v=this._decodePng;break;case "BSQ":v=this._decodeBsq;break;case "BIP":v=this._decodeBip;break;case "TIFF":v=this._decodeTiff;break;default:v=function(E,H){throw"The raster format is not supported";}}v=I.hitch(this,v);return function(E,
H){var B=new e;try{if("LERC"===r||!0===O){var a=v(E,H);B.resolve(a)}else F.then(function(){a=v(E,H);B.resolve(a)})}catch(c){B.reject(c)}return B}},_getFormat:function(r){r=new Uint8Array(r,0,10);var v="";if(255===r[0]&&216===r[1])v="JPEG";else if(137===r[0]&&80===r[1]&&78===r[2]&&71===r[3])v="PNG";else if(67===r[0]&&110===r[1]&&116===r[2]&&90===r[3]&&73===r[4]&&109===r[5]&&97===r[6]&&103===r[7]&&101===r[8]&&32===r[9])v="LERC";else if(76===r[0]&&101===r[1]&&114===r[2]&&99===r[3]&&50===r[4]&&32===r[5])v=
"LERC2";else if(-1<String.fromCharCode.apply(null,r).toLowerCase().indexOf("error"))v="ERROR";else if(73===r[0]&&73===r[1]&&42===r[2]&&0===r[3]||77===r[0]&&77===r[1]&&0===r[2]&&42===r[3])v="TIFF";return v},_validateDecodeParams:function(r){if(!r.height||Math.floor(r.height)!==r.height)throw"Height not provided.";if(!r.width||Math.floor(r.width)!==r.width)throw"Width not provided.";},_decodeJpeg:function(r,v){if(!G)throw"The jpeg decoder module is not loaded.";this._validateDecodeParams(v);r=(new G).decode(r);
if(!Q(r,v))throw"The decoded image dimensions are incorrect.";v=[];var E;for(E=0;E<r.pixels.length;E++){var H=r.pixels[E];v.push(this._calculateBandStatistics(H))}return new p({width:r.width,height:r.height,pixels:r.pixels,pixelType:"U8",mask:r.mask,statistics:v})},_decodePng:function(r,v){if(!M)throw"The png decoder module is not loaded.";this._validateDecodeParams(v);r=new Uint8Array(r);var E=new M(r);r=new Uint8Array(v.width*v.height*4);E.copyToImageData(r,E.decodePixels());var H=E=0;H=new Uint8Array(v.width*
v.height);for(E=0;E<v.width*v.height;E++)H[E]=r[4*E+3];var B=new p({width:v.width,height:v.height,pixels:[],pixelType:"U8",mask:H,statistics:[]});for(E=0;3>E;E++){var a=new Uint8Array(v.width*v.height);for(H=0;H<v.width*v.height;H++)a[H]=r[4*H+E];B.addData({pixels:a,statistics:this._calculateBandStatistics(a)})}return B},_decodeBsq:function(r,v){if(!S)throw"The bsq decoder module is not loaded.";this._validateDecodeParams(v);K=v.noDataValue;v.pixelType=D(v.pixelType);r=S.decodeBSQ(r,{bandCount:v.planes,
width:v.width,height:v.height,pixelType:N,noDataValue:K});var E=[],H,B=null;for(H=0;H<r.pixels.length;H++)B=r.pixels[H],E.push(this._calculateBandStatistics(B));return new p({width:v.width,height:v.height,pixels:r.pixels,pixelType:v.pixelType,mask:r.maskData,statistics:E})},_decodeBip:function(r,v){this._validateDecodeParams(v);K=v.noDataValue;v.pixelType=D(v.pixelType);r=S.decodeBIP(r,{bandCount:v.planes,width:v.width,height:v.height,pixelType:N,noDataValue:K});var E=[],H,B=null;for(H=0;H<r.pixels.length;H++)B=
r.pixels[H],E.push(this._calculateBandStatistics(B));return new p({width:v.width,height:v.height,pixels:r.pixels,pixelType:v.pixelType,mask:r.maskData,statistics:E})},_decodeTiff:function(r,v){this._validateDecodeParams(v);K=v.noDataValue;v.pixelType=D(v.pixelType);r=R.decode(r);v=[];var E,H=null;for(E=0;E<r.pixels.length;E++)H=r.pixels[E],v.push(this._calculateBandStatistics(H,r.maskData));return new p({width:r.width,height:r.height,pixels:r.pixels,pixelType:r.pixelType,mask:r.maskData,statistics:v})},
_decodeLerc:function(r,v){this._validateDecodeParams(v);K=v.noDataValue;v.pixelType=D(v.pixelType);for(var E=0,H,B=0,a,c=r.byteLength-10;B<c;){var l=x.decode(r,{inputOffset:B,encodedMaskData:H,returnMask:0===E?!0:!1,returnEncodedMask:0===E?!0:!1,returnFileInfo:!0,pixelType:N,noDataValue:K});B=l.fileInfo.eofOffset;0===E&&(H=l.encodedMaskData,a=new p({width:v.width,height:v.height,pixels:[],pixelType:v.pixelType,mask:l.maskData,statistics:[]}));E++;if(!Q(l,v))throw"The decoded image dimensions are incorrect";
a.addData({pixels:l.pixelData,statistics:{minValue:l.minValue,maxValue:l.maxValue,noDataValue:l.noDataValue}})}return a},_decodeLerc2:function(r,v){this._validateDecodeParams(v);K=v.noDataValue;v.pixelType=D(v.pixelType);for(var E=0,H,B,a=0,c,l=r.byteLength-10,u=[];a<l;){B=w.decode(r,{inputOffset:a,maskData:H,returnFileInfo:!0});a=B.fileInfo.eofOffset;0===E&&(H=B.maskData,c=new p({width:v.width,height:v.height,pixels:[],pixelType:B.fileInfo.pixelType,mask:B.maskData,statistics:[]}));B.fileInfo.mask&&
0<B.fileInfo.mask.numBytes&&u.push(B.maskData);E++;if(!Q(B,v))throw"The decoded image dimensions are incorrect";if(1<B.dimCount&&B.pixelData&&B.pixelData.length===B.width*B.height*B.dimCount){B.pixelData=B.pixelData.slice(-B.width*B.height);var y=B.dimStats&&B.dimStats.minValues&&B.dimStats.minValues[B.dimCount-1],C=B.dimStats&&B.dimStats.maxValues&&B.dimStats.maxValues[B.dimCount-1];null!=y&&null!=C&&(B.minValue=y,B.maxValue=C)}c.addData({pixels:B.pixelData,statistics:{minValue:B.minValue,maxValue:B.maxValue,
noDataValue:B.noDataValue}})}if(1<u.length){B=c.width*c.height;c.bandMasks=u;H=new Uint8Array(B);H.set(u[0]);for(v=1;v<u.length;v++)for(r=u[v],E=0;E<B;E++)H[E]&=r[E];c.maskData=H}return c},_calculateBandStatistics:function(r,v){var E=Infinity,H=-Infinity,B=r.length,a,c=0;if(v)for(a=0;a<B;a++)v[a]&&(c=r[a],E=c<E?c:E,H=c>H?c:H);else for(a=0;a<B;a++)c=r[a],E=c<E?c:E,H=c>H?c:H;return{minValue:E,maxValue:H}},_loadRasterFormatModules:function(){O||(F||(F=new e),10>f("ie")?F.isRejected()||F.reject("unsupported browser version"):
J(["./rasterFormats/JpgPlus","./rasterFormats/Png","./rasterFormats/Raw","./rasterFormats/TiffDecoder","./rasterFormats/Zlib"],function(r,v,E,H){G=r;M=v;S=E;R=H;O=!0;F.isResolved()||F.resolve(!0)}))}});var N=null,K=null,D=function(r){if("U1"===r||"U2"===r||"U4"===r||"U8"===r)return K=Math.pow(2,8)-1,N=Uint8Array,"U8";"U16"===r?(K=K||Math.pow(2,16)-1,N=Uint16Array):"U32"===r?(K=K||Math.pow(2,32)-1,N=Uint32Array):"S8"===r?(K=K||0-Math.pow(2,7),N=Int8Array):"S16"===r?(K=K||0-Math.pow(2,15),N=Int16Array):
"S32"===r?(K=K||0-Math.pow(2,31),N=Int32Array):N=Float32Array;return r},Q=function(r,v){return r.height!==v.height||r.width!==v.width?!1:!0};f("extend-esri")&&I.setObject("layers.Raster",z,h);return z})},"esri/layers/PixelBlock":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(J,z,I,e){J=J([],{declaredClass:"esri.layers.PixelBlock",planes:null,width:null,height:null,pixelType:null,pixels:[],statistics:[],maskIsAlpha:!1,validPixelCount:null,constructor:function(b){if(b){if(!b.width||
Math.floor(b.width)!==b.width)throw"PixelBlock: incorrect width";if(!b.height||Math.floor(b.height)!==b.height)throw"PixelBlock: incorrect height";if(!b.pixels)throw"PixelBlock: pixel data not present";this.width=b.width;this.height=b.height;this.pixels=b.pixels;this.pixelType=b.pixelType||null;this.statistics=b.statistics;this.mask=b.mask||null;this.maskIsAlpha=b.maskIsAlpha||!1;b=b.validPixelCount;null==b&&(b=this.mask?this._getValidPixelCount(this.mask):this.width*this.height);this.validPixelCount=
b}},getPlaneCount:function(){return this.pixels.length!==this.statistics.length?console.error("Inconsistent pixel data and statistics"):this.statistics.length},addData:function(b){if(!b.pixels||!b.statistics)throw"Pixel data or statistics are not present";if(b.pixels.length!==this.width*this.height)throw"Inconsistent pixel data size";this.statistics.push(b.statistics);this.pixels.push(b.pixels)},getAsRGBA:function(){var b=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case "S8":case "S16":case "U16":case "S32":case "U32":case "F32":case "F64":this._fillFromNon8Bit(b);
break;default:this._fillFrom8Bit(b)}return new Uint8ClampedArray(b)},getAsRGBAFloat:function(){var b=new Float32Array(this.width*this.height*4);this._fillFrom32Bit(b);return b},clone:function(b){b=b||this;var d=new this.constructor;d.width=b.width;d.height=b.height;d.pixelType=b.pixelType;d.maskIsAlpha=b.maskIsAlpha;b.mask&&(d.mask=new Uint8Array(b.mask));var g,f;if(b.pixels){d.pixels=[];var h=(f=b.pixels.length)&&b.pixels[0].slice;for(g=0;g<f;g++)d.pixels[g]=h?b.pixels[g].slice(0,b.pixels[g].length):
new b.pixels[g].constructor(b.pixels[g])}if(b.statistics)for(d.statistics=[],f=b.statistics.length,g=0;g<f;g++)d.statistics[g]=z.clone(b.statistics[g]);b=b.validPixelCount;null==b&&(b=d.mask?this._getValidPixelCount(d.mask):d.width*d.height);return d},clamp:function(b){if("F64"!==b&&"F32"!==b){switch(b){case "U8":var d=[0,255];break;case "U16":d=[0,65535];break;case "U32":d=[0,4294967295];break;case "S8":d=[-128,127];break;case "S16":d=[-32768,32767];break;case "S32":d=[-2147483648,2147483647];break;
default:d=[-3.4*1E39,3.4*1E39]}var g=d[0];d=d[1];var f=this.pixels,h=this.width*this.height,n=f.length,m,k,q=[];for(m=0;m<n;m++){var t=this._createEmptyBand(b,h);var p=f[m];for(k=0;k<h;k++){var x=p[k];t[k]=x>d?d:x<g?g:x}q.push(t)}this.pixels=q;this.pixelType=b}},calculateStatistics:function(){var b,d=[],g=this.mask;for(b=0;b<this.pixels.length;b++){var f=this.pixels[b];d.push(this._calculateBandStatistics(f,g))}this.statistics=d},_getValidPixelCount:function(b){var d,g=0;for(d=0;d<b.length;d++)b[d]&&
g++;return g},_createEmptyBand:function(b,d){switch(b){case "U8":b=new Uint8Array(d);break;case "U16":b=new Uint16Array(d);break;case "U32":b=new Uint32Array(d);break;case "S8":b=new Int8Array(d);break;case "S16":b=new Int16Array(d);break;case "S32":b=new Int32Array(d);break;case "U32":b=new Uint32Array(d);break;case "F32":b=new Float32Array(d);break;case "F64":b=new Float64Array(d);break;default:b=new Float32Array(d)}return b},_fillFrom8Bit:function(b){var d=this.pixels,g=this.mask;if(!b||!d||!d.length)return console.error("Unable to convert to RGBA. The input pixel block is empty.");
var f,h;var n=f=h=d[0];3<=d.length&&(f=d[1],h=d[2]);d=new Uint32Array(b);var m=this.width*this.height;if(n.length!==m)return console.error("Unable to convert to RGBA. The pixelblock is invalid.");if(g&&g.length===m)if(this.maskIsAlpha)for(b=0;b<m;b++)g[b]&&(d[b]=g[b]<<24|h[b]<<16|f[b]<<8|n[b]);else for(b=0;b<m;b++)g[b]&&(d[b]=-16777216|h[b]<<16|f[b]<<8|n[b]);else for(b=0;b<m;b++)d[b]=-16777216|h[b]<<16|f[b]<<8|n[b]},_fillFromNon8Bit:function(b){var d=this.pixels,g=this.mask,f=this.statistics;if(!b||
!d||!d.length)return console.error("Unable to convert to RGBA. The input pixel block is empty.");var h=1,n=0;h=1;f&&0<f.length?(n=f.map(function(t){return t.minValue}).reduce(function(t,p){return Math.min(t,p)}),h=f.map(function(t){return t.maxValue-t.minValue}).reduce(function(t,p){return Math.max(t,p)}),h=255/h):(h=255,"S8"===this.pixelType?(n=-128,h=127):"U16"===this.pixelType?h=65535:"S16"===this.pixelType?(n=-32768,h=32767):"U32"===this.pixelType?h=4294967295:"S32"===this.pixelType?(n=-2147483648,
h=2147483647):"F32"===this.pixelType?(n=-3.4*1E39,h=3.4*1E39):"F64"===this.pixelType&&(n=-Number.MAX_VALUE,h=Number.MAX_VALUE),h=255/(h-n));b=new Uint32Array(b);f=this.width*this.height;var m=d[0];if(m.length!==f)return console.error("Unable to convert to RGBA. The pixelblock is invalid.");if(3<=d.length){var k=d[1];var q=d[2];if(g&&g.length===f)for(d=0;d<f;d++)g[d]&&(b[d]=-16777216|(q[d]-n)*h<<16|(k[d]-n)*h<<8|(m[d]-n)*h);else for(d=0;d<f;d++)b[d]=-16777216|(q[d]-n)*h<<16|(k[d]-n)*h<<8|(m[d]-n)*
h}else if(g&&g.length===f)for(d=0;d<f;d++)k=(m[d]-n)*h,g[d]&&(b[d]=-16777216|k<<16|k<<8|k);else for(d=0;d<f;d++)k=(m[d]-n)*h,b[d]=-16777216|k<<16|k<<8|k},_fillFrom32Bit:function(b){var d=this.pixels,g=this.mask;if(!b||!d||!d.length)return console.error("Unable to convert to RGBA. The input pixel block is empty.");var f,h;var n=f=h=d[0];3<=d.length&&(f=d[1],h=d[2]);var m=this.width*this.height;if(n.length!==m)return console.error("Unable to convert to RGBA. The pixelblock is invalid.");var k=0;if(g&&
g.length===m)for(d=0;d<m;d++)b[k++]=n[d],b[k++]=f[d],b[k++]=h[d],b[k++]=g[d]&1;else for(d=0;d<m;d++)b[k++]=n[d],b[k++]=f[d],b[k++]=h[d],b[k++]=1},_calculateBandStatistics:function(b,d){var g=Infinity,f=-Infinity,h=b.length,n,m=0;if(d)for(n=0;n<h;n++)d[n]&&(m=b[n],g=m<g?m:g,f=m>f?m:f);else for(n=0;n<h;n++)m=b[n],g=m<g?m:g,f=m>f?m:f;return{minValue:g,maxValue:f}}});I("extend-esri")&&z.setObject("layers.PixelBlock",J,e);return J})},"esri/layers/rasterFormats/LercCodec":function(){define([],function(){var J=
{defaultNoDataValue:-3.4027999387901484E38,decode:function(I,e){e=e||{};var b=e.inputOffset||0,d=e.encodedMaskData||null===e.encodedMaskData,g={},f=new Uint8Array(I,b,10);g.fileIdentifierString=String.fromCharCode.apply(null,f);if("CntZImage"!=g.fileIdentifierString.trim())throw"Unexpected file identifier string: "+g.fileIdentifierString;b+=10;f=new DataView(I,b,24);g.fileVersion=f.getInt32(0,!0);g.imageType=f.getInt32(4,!0);g.height=f.getUint32(8,!0);g.width=f.getUint32(12,!0);g.maxZError=f.getFloat64(16,
!0);b+=24;if(!d)if(f=new DataView(I,b,16),g.mask={},g.mask.numBlocksY=f.getUint32(0,!0),g.mask.numBlocksX=f.getUint32(4,!0),g.mask.numBytes=f.getUint32(8,!0),g.mask.maxValue=f.getFloat32(12,!0),b+=16,0<g.mask.numBytes){d=new Uint8Array(Math.ceil(g.width*g.height/8));f=new DataView(I,b,g.mask.numBytes);var h=f.getInt16(0,!0),n=2,m=0;do{if(0<h)for(;h--;)d[m++]=f.getUint8(n++);else{var k=f.getUint8(n++);for(h=-h;h--;)d[m++]=k}h=f.getInt16(n,!0);n+=2}while(n<g.mask.numBytes);if(-32768!==h||m<d.length)throw"Unexpected end of mask RLE encoding";
g.mask.bitset=d;b+=g.mask.numBytes}else 0===(g.mask.numBytes|g.mask.numBlocksY|g.mask.maxValue)&&(d=new Uint8Array(Math.ceil(g.width*g.height/8)),g.mask.bitset=d);f=new DataView(I,b,16);g.pixels={};g.pixels.numBlocksY=f.getUint32(0,!0);g.pixels.numBlocksX=f.getUint32(4,!0);g.pixels.numBytes=f.getUint32(8,!0);g.pixels.maxValue=f.getFloat32(12,!0);b+=16;d=g.pixels.numBlocksX;f=g.pixels.numBlocksY;d+=0<g.width%d?1:0;h=f+(0<g.height%f?1:0);g.pixels.blocks=Array(d*h);for(m=n=0;m<h;m++)for(k=0;k<d;k++){var q=
0;f=new DataView(I,b,Math.min(10,I.byteLength-b));var t={};g.pixels.blocks[n++]=t;var p=f.getUint8(0);q++;t.encoding=p&63;if(3<t.encoding)throw"Invalid block encoding ("+t.encoding+")";if(2===t.encoding)b++;else{if(0!==p&&2!==p){p>>=6;t.offsetType=p;if(2===p)t.offset=f.getInt8(1),q++;else if(1===p)t.offset=f.getInt16(1,!0),q+=2;else if(0===p)t.offset=f.getFloat32(1,!0),q+=4;else throw"Invalid block offset type";if(1===t.encoding)if(p=f.getUint8(q),q++,t.bitsPerPixel=p&63,p>>=6,t.numValidPixelsType=
p,2===p)t.numValidPixels=f.getUint8(q),q++;else if(1===p)t.numValidPixels=f.getUint16(q,!0),q+=2;else if(0===p)t.numValidPixels=f.getUint32(q,!0),q+=4;else throw"Invalid valid pixel count type";}b+=q;if(3!=t.encoding)if(0===t.encoding){p=(g.pixels.numBytes-1)/4;if(p!==Math.floor(p))throw"uncompressed block has invalid length";f=new ArrayBuffer(4*p);q=new Uint8Array(f);q.set(new Uint8Array(I,b,4*p));f=new Float32Array(f);t.rawData=f;b+=4*p}else 1===t.encoding&&(p=Math.ceil(t.numValidPixels*t.bitsPerPixel/
8),f=new ArrayBuffer(4*Math.ceil(p/4)),q=new Uint8Array(f),q.set(new Uint8Array(I,b,p)),t.stuffedData=new Uint32Array(f),b+=p)}}g.eofOffset=b;I=null!=e.noDataValue?e.noDataValue:J.defaultNoDataValue;d=e.encodedMaskData;p=e.returnMask;h=0;n=g.pixels.numBlocksX;m=g.pixels.numBlocksY;k=Math.floor(g.width/n);t=Math.floor(g.height/m);q=2*g.maxZError;b=Number.MAX_VALUE;d=d||(g.mask?g.mask.bitset:null);var x;f=new (e.pixelType||Float32Array)(g.width*g.height);p&&d&&(x=new Uint8Array(g.width*g.height));p=
new Float32Array(k*t);for(var w,G,M=0;M<=m;M++){var S=M!==m?t:g.height%m;if(0!==S)for(var R=0;R<=n;R++){var O=R!==n?k:g.width%n;if(0!==O){var F=M*g.width*t+R*k,N=g.width-O,K=g.pixels.blocks[h],D;if(2>K.encoding){if(0===K.encoding)var Q=K.rawData;else{var r=D=Q=void 0;w=K.stuffedData;G=K.bitsPerPixel;var v=K.numValidPixels,E=K.offset,H=q,B=p,a=g.pixels.maxValue,c=(1<<G)-1,l=0,u=0,y=Math.ceil((a-E)/H);w[w.length-1]<<=8*(4*w.length-Math.ceil(G*v/8));for(r=0;r<v;r++)0===u&&(Q=w[l++],u=32),u>=G?(D=Q>>>
u-G&c,u-=G):(u=G-u,D=(Q&c)<<u&c,Q=w[l++],u=32-u,D+=Q>>>u),B[r]=D<y?E+D*H:a;Q=p}D=0}else var C=2===K.encoding?0:K.offset;if(d)for(G=0;G<S;G++){if(F&7){var A=d[F>>3];A<<=F&7}for(w=0;w<O;w++)F&7||(A=d[F>>3]),A&128?(x&&(x[F]=1),r=2>K.encoding?Q[D++]:C,b=b>r?r:b,f[F++]=r):(x&&(x[F]=0),f[F++]=I),A<<=1;F+=N}else if(2>K.encoding)for(G=0;G<S;G++){for(w=0;w<O;w++)r=Q[D++],b=b>r?r:b,f[F++]=r;F+=N}else for(b=b>C?C:b,G=0;G<S;G++){for(w=0;w<O;w++)f[F++]=C;F+=N}if(1===K.encoding&&D!==K.numValidPixels)throw"Block and Mask do not match";
h++}}}C=x;x={width:g.width,height:g.height,pixelData:f,minValue:b,maxValue:g.pixels.maxValue,noDataValue:I};C&&(x.maskData=C);e.returnEncodedMask&&g.mask&&(x.encodedMaskData=g.mask.bitset?g.mask.bitset:null);if(e.returnFileInfo&&(x.fileInfo=z(g),e.computeUsedBitDepths)){e=x.fileInfo;C=g.pixels.numBlocksX*g.pixels.numBlocksY;A={};for(Q=0;Q<C;Q++)D=g.pixels.blocks[Q],0===D.encoding?A.float32=!0:1===D.encoding?A[D.bitsPerPixel]=!0:A[0]=!0;g=Object.keys(A);e.bitDepths=g}return x}},z=function(I){return{fileIdentifierString:I.fileIdentifierString,
fileVersion:I.fileVersion,imageType:I.imageType,height:I.height,width:I.width,maxZError:I.maxZError,eofOffset:I.eofOffset,mask:I.mask?{numBlocksX:I.mask.numBlocksX,numBlocksY:I.mask.numBlocksY,numBytes:I.mask.numBytes,maxValue:I.mask.maxValue}:null,pixels:{numBlocksX:I.pixels.numBlocksX,numBlocksY:I.pixels.numBlocksY,numBytes:I.pixels.numBytes,maxValue:I.pixels.maxValue,noDataValue:this.noDataValue}}};return J})},"esri/layers/rasterFormats/Lerc2Codec":function(){define([],function(){var J={unstuff:function(e,
b,d,g,f,h,n,m){var k=(1<<d)-1,q=0,t,p=0;e[e.length-1]<<=8*(4*e.length-Math.ceil(d*g/8));if(f)for(t=0;t<g;t++){if(0===p){var x=e[q++];p=32}if(p>=d){var w=x>>>p-d&k;p-=d}else p=d-p,w=(x&k)<<p&k,x=e[q++],p=32-p,w+=x>>>p;b[t]=f[w]}else for(f=Math.ceil((m-h)/n),t=0;t<g;t++)0===p&&(x=e[q++],p=32),p>=d?(w=x>>>p-d&k,p-=d):(p=d-p,w=(x&k)<<p&k,x=e[q++],p=32-p,w+=x>>>p),b[t]=w<f?h+w*n:m},unstuffLUT:function(e,b,d,g,f,h){var n=(1<<b)-1,m=0,k=0,q=0,t=q=0,p=[];e[e.length-1]<<=8*(4*e.length-Math.ceil(b*d/8));var x=
Math.ceil((h-g)/f);for(k=0;k<d;k++){if(0===q){var w=e[m++];q=32}q>=b?(t=w>>>q-b&n,q-=b):(q=b-q,t=(w&n)<<q&n,w=e[m++],q=32-q,t+=w>>>q);p[k]=t<x?g+t*f:h}p.unshift(g);return p},unstuff2:function(e,b,d,g,f,h,n,m){var k=(1<<d)-1,q=0,t,p=0,x=0;if(f)for(t=0;t<g;t++){if(0===p){var w=e[q++];p=32;x=0}if(p>=d){var G=w>>>x&k;p-=d;x+=d}else{var M=d-p;G=w>>>x&k;w=e[q++];p=32-M;G|=(w&(1<<M)-1)<<d-M;x=M}b[t]=f[G]}else for(f=Math.ceil((m-h)/n),t=0;t<g;t++)0===p&&(w=e[q++],p=32,x=0),p>=d?(G=w>>>x&k,p-=d,x+=d):(M=d-
p,G=w>>>x&k,w=e[q++],p=32-M,G|=(w&(1<<M)-1)<<d-M,x=M),b[t]=G<f?h+G*n:m;return b},unstuffLUT2:function(e,b,d,g,f,h){var n=(1<<b)-1,m=0,k=0,q=0,t=0,p=0,x=0,w=[],G=Math.ceil((h-g)/f);for(k=0;k<d;k++){if(0===t){var M=e[m++];t=32;x=0}t>=b?(p=M>>>x&n,t-=b,x+=b):(q=b-t,p=M>>>x&n,M=e[m++],t=32-q,p|=(M&(1<<q)-1)<<b-q,x=q);w[k]=p<G?g+p*f:h}w.unshift(g);return w},originalUnstuff:function(e,b,d,g){var f=(1<<d)-1,h=0,n,m=0;e[e.length-1]<<=8*(4*e.length-Math.ceil(d*g/8));for(n=0;n<g;n++){if(0===m){var k=e[h++];
m=32}if(m>=d){var q=k>>>m-d&f;m-=d}else m=d-m,q=(k&f)<<m&f,k=e[h++],m=32-m,q+=k>>>m;b[n]=q}return b},originalUnstuff2:function(e,b,d,g){var f=(1<<d)-1,h=0,n,m=0,k=0;for(n=0;n<g;n++){if(0===m){var q=e[h++];m=32;k=0}if(m>=d){var t=q>>>k&f;m-=d;k+=d}else{var p=d-m;t=q>>>k&f;q=e[h++];m=32-p;t|=(q&(1<<p)-1)<<d-p;k=p}b[n]=t}return b}},z={HUFFMAN_LUT_BITS_MAX:12,computeChecksumFletcher32:function(e){for(var b=65535,d=65535,g=e.length,f=Math.floor(g/2),h=0;f;){var n=359<=f?359:f;f-=n;do b+=e[h++]<<8,d+=b+=
e[h++];while(--n);b=(b&65535)+(b>>>16);d=(d&65535)+(d>>>16)}g&1&&(d+=b+=e[h]<<8);return((d&65535)+(d>>>16)<<16|(b&65535)+(b>>>16))>>>0},readHeaderInfo:function(e,b){var d=b.ptr,g=new Uint8Array(e,d,6),f={};f.fileIdentifierString=String.fromCharCode.apply(null,g);if(0!==f.fileIdentifierString.lastIndexOf("Lerc2",0))throw"Unexpected file identifier string (expect Lerc2 ): "+f.fileIdentifierString;d+=6;g=new DataView(e,d,8);var h=g.getInt32(0,!0);f.fileVersion=h;d+=4;3<=h&&(f.checksum=g.getUint32(4,
!0),d+=4);g=new DataView(e,d,12);f.height=g.getUint32(0,!0);f.width=g.getUint32(4,!0);d+=8;4<=h?(f.numDims=g.getUint32(8,!0),d+=4):f.numDims=1;g=new DataView(e,d,40);f.numValidPixel=g.getUint32(0,!0);f.microBlockSize=g.getInt32(4,!0);f.blobSize=g.getInt32(8,!0);f.imageType=g.getInt32(12,!0);f.maxZError=g.getFloat64(16,!0);f.zMin=g.getFloat64(24,!0);f.zMax=g.getFloat64(32,!0);d+=40;b.headerInfo=f;b.ptr=d;if(3<=h&&(e=this.computeChecksumFletcher32(new Uint8Array(e,d-(4<=h?52:48),f.blobSize-14)),e!==
f.checksum))throw"Checksum failed.";return!0},checkMinMaxRanges:function(e,b){var d=b.headerInfo,g=this.getDataTypeArray(d.imageType),f=d.numDims*this.getDataTypeSize(d.imageType),h=this.readSubArray(e,b.ptr,g,f);e=this.readSubArray(e,b.ptr+f,g,f);b.ptr+=2*f;f=!0;for(b=0;b<d.numDims;b++)if(h[b]!==e[b]){f=!1;break}d.minValues=h;d.maxValues=e;return f},readSubArray:function(e,b,d,g){if(d===Uint8Array)e=new Uint8Array(e,b,g);else{var f=new ArrayBuffer(g);(new Uint8Array(f)).set(new Uint8Array(e,b,g));
e=new d(f)}return e},readMask:function(e,b){var d=b.ptr,g=b.headerInfo,f=g.width*g.height,h=g.numValidPixel,n=new DataView(e,d,4);g={};g.numBytes=n.getUint32(0,!0);d+=4;if((0===h||f===h)&&0!==g.numBytes)throw"invalid mask";if(0===h)h=new Uint8Array(Math.ceil(f/8)),g.bitset=h,n=new Uint8Array(f),b.pixels.resultMask=n,d+=g.numBytes;else if(0<g.numBytes){h=new Uint8Array(Math.ceil(f/8));n=new DataView(e,d,g.numBytes);e=n.getInt16(0,!0);var m=2,k=0,q=0;do{if(0<e)for(;e--;)h[k++]=n.getUint8(m++);else for(q=
n.getUint8(m++),e=-e;e--;)h[k++]=q;e=n.getInt16(m,!0);m+=2}while(m<g.numBytes);if(-32768!==e||k<h.length)throw"Unexpected end of mask RLE encoding";n=new Uint8Array(f);for(m=m=e=0;m<f;m++)m&7?(e=h[m>>3],e<<=m&7):e=h[m>>3],e&128&&(n[m]=1);b.pixels.resultMask=n;g.bitset=h;d+=g.numBytes}b.ptr=d;b.mask=g;return!0},readDataOneSweep:function(e,b,d,g){var f=b.ptr,h=b.headerInfo,n=h.numDims,m=h.width*h.height;h=h.numValidPixel*z.getDataTypeSize(h.imageType)*n;var k=b.pixels.resultMask;if(d===Uint8Array)e=
new Uint8Array(e,f,h);else{var q=new ArrayBuffer(h);(new Uint8Array(q)).set(new Uint8Array(e,f,h));e=new d(q)}if(e.length===m*n)b.pixels.resultPixels=g?z.swapDimensionOrder(e,m,n,d,!0):e;else{b.pixels.resultPixels=new d(m*n);var t=q=d=0,p=0;if(1<n)if(g)for(q=0;q<m;q++){if(k[q])for(p=q,t=0;t<n;t++,p+=m)b.pixels.resultPixels[p]=e[d++]}else for(q=0;q<m;q++){if(k[q])for(p=q*n,t=0;t<n;t++)b.pixels.resultPixels[p+t]=e[d++]}else for(q=0;q<m;q++)k[q]&&(b.pixels.resultPixels[q]=e[d++])}b.ptr=f+h;return!0},
readHuffmanTree:function(e,b){var d=this.HUFFMAN_LUT_BITS_MAX,g=new DataView(e,b.ptr,16);b.ptr+=16;if(2>g.getInt32(0,!0))throw"unsupported Huffman version";var f=g.getInt32(4,!0),h=g.getInt32(8,!0);g=g.getInt32(12,!0);if(h>=g)return!1;var n=new Uint32Array(g-h);z.decodeBits(e,b,n);var m=[],k;for(k=h;k<g;k++){var q=k-(k<f?0:f);m[q]={first:n[k-h],second:null}}k=e.byteLength-b.ptr;n=new ArrayBuffer(4*Math.ceil(k/4));(new Uint8Array(n)).set(new Uint8Array(e,b.ptr,k));e=new Uint32Array(n);b=0;n=0;var t=
e[0];for(k=h;k<g;k++){q=k-(k<f?0:f);var p=m[q].first;0<p&&(m[q].second=t<<b>>>32-p,32-b>=p?(b+=p,32===b&&(b=0,n++,t=e[n])):(b+=p-32,n++,t=e[n],m[q].second|=t>>>32-b))}var x=t=0,w=new I;for(k=0;k<m.length;k++)void 0!==m[k]&&(t=Math.max(t,m[k].first));x=t>=d?d:t;d=[];var G;for(k=h;k<g;k++)if(q=k-(k<f?0:f),p=m[q].first,0<p)if(h=[p,q],p<=x){q=m[q].second<<x-p;var M=1<<x-p;for(p=0;p<M;p++)d[q|p]=h}else for(q=m[q].second,M=w,--p;0<=p;p--)(G=q>>>p&1)?(M.right||(M.right=new I),M=M.right):(M.left||(M.left=
new I),M=M.left),0!==p||M.val||(M.val=h[1]);return{decodeLut:d,numBitsLUTQick:x,numBitsLUT:t,tree:w,stuffedData:e,srcPtr:n,bitPos:b}},readHuffman:function(e,b,d,g){var f=b.headerInfo.numDims,h=b.headerInfo.height,n=b.headerInfo.width,m=n*h,k=this.readHuffmanTree(e,b);e=k.decodeLut;var q=k.tree,t=k.stuffedData,p=k.srcPtr,x=k.bitPos,w=k.numBitsLUTQick;k=k.numBitsLUT;var G=0===b.headerInfo.imageType?128:0,M=b.pixels.resultMask,S,R,O,F,N,K,D=0;0<x&&(p++,x=0);var Q=t[p],r=1===b.encodeMode,v=new d(m*f),
E=v,H;if(2>f||r)for(H=0;H<f;H++)if(1<f&&(E=new d(v.buffer,m*H,m),D=0),b.headerInfo.numValidPixel===n*h)for(O=N=0;O<h;O++)for(F=0;F<n;F++,N++){var B=0;var a=S=Q<<x>>>32-w;32-x<w&&(a=S|=t[p+1]>>>64-x-w);if(e[a])B=e[a][1],x+=e[a][0];else for(a=S=Q<<x>>>32-k,32-x<k&&(a=S|=t[p+1]>>>64-x-k),a=q,K=0;K<k;K++)if(a=(R=S>>>k-K-1&1)?a.right:a.left,!a.left&&!a.right){B=a.val;x=x+K+1;break}32<=x&&(x-=32,p++,Q=t[p]);B-=G;r?(B=0<F?B+D:0<O?B+E[N-n]:B+D,B&=255,D=E[N]=B):E[N]=B}else for(O=N=0;O<h;O++)for(F=0;F<n;F++,
N++){if(M[N]){B=0;a=S=Q<<x>>>32-w;32-x<w&&(a=S|=t[p+1]>>>64-x-w);if(e[a])B=e[a][1],x+=e[a][0];else for(a=S=Q<<x>>>32-k,32-x<k&&(a=S|=t[p+1]>>>64-x-k),a=q,K=0;K<k;K++)if(a=(R=S>>>k-K-1&1)?a.right:a.left,!a.left&&!a.right){B=a.val;x=x+K+1;break}32<=x&&(x-=32,p++,Q=t[p]);B-=G;r?(B=0<F&&M[N-1]?B+D:0<O&&M[N-n]?B+E[N-n]:B+D,B&=255,D=E[N]=B):E[N]=B}}else for(O=N=0;O<h;O++)for(F=0;F<n;F++)if(N=O*n+F,!M||M[N])for(H=0;H<f;H++,N+=m){B=0;a=S=Q<<x>>>32-w;32-x<w&&(a=S|=t[p+1]>>>64-x-w);if(e[a])B=e[a][1],x+=e[a][0];
else for(a=S=Q<<x>>>32-k,32-x<k&&(a=S|=t[p+1]>>>64-x-k),a=q,K=0;K<k;K++)if(a=(R=S>>>k-K-1&1)?a.right:a.left,!a.left&&!a.right){B=a.val;x=x+K+1;break}32<=x&&(x-=32,p++,Q=t[p]);B-=G;E[N]=B}b.ptr=b.ptr+4*(p+1)+(0<x?4:0);b.pixels.resultPixels=v;1<f&&!g&&(b.pixels.resultPixels=z.swapDimensionOrder(v,m,f,d))},decodeBits:function(e,b,d,g,f){var h=b.headerInfo,n=h.fileVersion,m=0,k=new DataView(e,b.ptr,5<=e.byteLength-b.ptr?5:e.byteLength-b.ptr),q=k.getUint8(0);m++;var t=q>>6,p=0===t?4:3-t,x=0<(q&32)?!0:
!1;t=q&31;q=0;if(1===p)q=k.getUint8(m),m++;else if(2===p)q=k.getUint16(m,!0),m+=2;else if(4===p)q=k.getUint32(m,!0),m+=4;else throw"Invalid valid pixel count type";p=2*h.maxZError;f=1<h.numDims?h.maxValues[f]:h.zMax;if(x){b.counter.lut++;x=k.getUint8(m);m++;h=Math.ceil((x-1)*t/8);var w=Math.ceil(h/4);w=new ArrayBuffer(4*w);var G=new Uint8Array(w);b.ptr+=m;G.set(new Uint8Array(e,b.ptr,h));m=new Uint32Array(w);b.ptr+=h;for(k=0;x-1>>>k;)k++;h=Math.ceil(q*k/8);w=Math.ceil(h/4);w=new ArrayBuffer(4*w);
G=new Uint8Array(w);G.set(new Uint8Array(e,b.ptr,h));e=new Uint32Array(w);b.ptr+=h;b=3<=n?J.unstuffLUT2(m,t,x-1,g,p,f):J.unstuffLUT(m,t,x-1,g,p,f);3<=n?J.unstuff2(e,d,k,q,b):J.unstuff(e,d,k,q,b)}else b.counter.bitstuffer++,k=t,b.ptr+=m,0<k&&(h=Math.ceil(q*k/8),w=Math.ceil(h/4),w=new ArrayBuffer(4*w),G=new Uint8Array(w),G.set(new Uint8Array(e,b.ptr,h)),e=new Uint32Array(w),b.ptr+=h,3<=n?null==g?J.originalUnstuff2(e,d,k,q):J.unstuff2(e,d,k,q,!1,g,p,f):null==g?J.originalUnstuff(e,d,k,q):J.unstuff(e,
d,k,q,!1,g,p,f))},readTiles:function(e,b,d,g){var f=b.headerInfo,h=f.width,n=f.height,m=h*n,k=f.microBlockSize,q=f.imageType,t=z.getDataTypeSize(q),p=Math.ceil(h/k),x=Math.ceil(n/k);b.pixels.numBlocksY=x;b.pixels.numBlocksX=p;var w=b.pixels.ptr=0,G=0,M=0,S=0,R=0,O=0,F=0,N=0,K=w=0,D=0,Q=0,r=F=0;F=F=0;var v=new d(k*k);n=n%k||k;var E=h%k||k,H=f.numDims,B,a=b.pixels.resultMask,c=b.pixels.resultPixels,l=5<=f.fileVersion?14:15,u=f.zMax;for(M=0;M<x;M++)for(R=M!==x-1?k:n,S=0;S<p;S++)for(O=S!==p-1?k:E,D=M*
h*k+S*k,Q=h-O,B=0;B<H;B++){1<H?(r=c,D=M*h*k+S*k,c=new d(b.pixels.resultPixels.buffer,m*B*t,m),u=f.maxValues[B]):r=null;F=e.byteLength-b.ptr;G=new DataView(e,b.ptr,Math.min(10,F));var y={};F=0;N=G.getUint8(0);F++;var C=5<=f.fileVersion?N&4:0;w=N>>6&255;K=N>>2&l;if(K!==(S*k>>3&l))throw"integrity issue";if(C&&0===B)throw"integrity issue";N&=3;if(3<N)throw b.ptr+=F,"Invalid block encoding ("+N+")";if(2===N){if(C)if(a)for(w=0;w<R;w++)for(G=0;G<O;G++)a[D]&&(c[D]=r[D]),D++;else for(w=0;w<R;w++)for(G=0;G<
O;G++)c[D]=r[D],D++;b.counter.constant++;b.ptr+=F}else if(0===N){if(C)throw"integrity issue";b.counter.uncompressed++;b.ptr+=F;F=R*O*t;r=e.byteLength-b.ptr;F=F<r?F:r;r=new ArrayBuffer(0===F%t?F:F+t-F%t);C=new Uint8Array(r);C.set(new Uint8Array(e,b.ptr,F));r=new d(r);F=0;if(a)for(w=0;w<R;w++){for(G=0;G<O;G++)a[D]&&(c[D]=r[F++]),D++;D+=Q}else for(w=0;w<R;w++){for(G=0;G<O;G++)c[D++]=r[F++];D+=Q}b.ptr+=F*t}else if(w=z.getDataTypeUsed(C&&6>q?4:q,w),y=z.getOnePixel(y,F,w,G),F+=z.getDataTypeSize(w),3===
N)if(b.ptr+=F,b.counter.constantoffset++,a)for(w=0;w<R;w++){for(G=0;G<O;G++)a[D]&&(c[D]=C?Math.min(u,r[D]+y):y),D++;D+=Q}else for(w=0;w<R;w++){for(G=0;G<O;G++)c[D]=C?Math.min(u,r[D]+y):y,D++;D+=Q}else if(b.ptr+=F,z.decodeBits(e,b,v,y,B),F=0,C)if(a)for(w=0;w<R;w++){for(G=0;G<O;G++)a[D]&&(c[D]=v[F++]+r[D]),D++;D+=Q}else for(w=0;w<R;w++){for(G=0;G<O;G++)c[D]=v[F++]+r[D],D++;D+=Q}else if(a)for(w=0;w<R;w++){for(G=0;G<O;G++)a[D]&&(c[D]=v[F++]),D++;D+=Q}else for(w=0;w<R;w++){for(G=0;G<O;G++)c[D++]=v[F++];
D+=Q}}1<H&&!g&&(b.pixels.resultPixels=z.swapDimensionOrder(b.pixels.resultPixels,m,H,d))},formatFileInfo:function(e){return{fileIdentifierString:e.headerInfo.fileIdentifierString,fileVersion:e.headerInfo.fileVersion,imageType:e.headerInfo.imageType,height:e.headerInfo.height,width:e.headerInfo.width,numValidPixel:e.headerInfo.numValidPixel,microBlockSize:e.headerInfo.microBlockSize,blobSize:e.headerInfo.blobSize,maxZError:e.headerInfo.maxZError,pixelType:z.getPixelType(e.headerInfo.imageType),eofOffset:e.eofOffset,
mask:e.mask?{numBytes:e.mask.numBytes}:null,pixels:{numBlocksX:e.pixels.numBlocksX,numBlocksY:e.pixels.numBlocksY,maxValue:e.headerInfo.zMax,minValue:e.headerInfo.zMin,noDataValue:e.noDataValue}}},constructConstantSurface:function(e,b){var d=e.headerInfo.zMax,g=e.headerInfo.zMin,f=e.headerInfo.maxValues,h=e.headerInfo.numDims,n=e.headerInfo.height*e.headerInfo.width,m=0,k=0,q=0,t=e.pixels.resultMask;e=e.pixels.resultPixels;if(t)if(1<h)if(b)for(m=0;m<h;m++)for(q=m*n,d=f[m],k=0;k<n;k++)t[k]&&(e[q+k]=
d);else for(k=0;k<n;k++){if(t[k])for(q=k*h,m=0;m<h;m++)e[q+h]=f[m]}else for(k=0;k<n;k++)t[k]&&(e[k]=d);else if(1<h&&g!==d)if(b)for(m=0;m<h;m++)for(q=m*n,d=f[m],k=0;k<n;k++)e[q+k]=d;else for(k=0;k<n;k++)for(q=k*h,m=0;m<h;m++)e[q+m]=f[m];else for(k=0;k<n*h;k++)e[k]=d},getDataTypeArray:function(e){switch(e){case 0:e=Int8Array;break;case 1:e=Uint8Array;break;case 2:e=Int16Array;break;case 3:e=Uint16Array;break;case 4:e=Int32Array;break;case 5:e=Uint32Array;break;case 6:e=Float32Array;break;case 7:e=Float64Array;
break;default:e=Float32Array}return e},getPixelType:function(e){switch(e){case 0:e="S8";break;case 1:e="U8";break;case 2:e="S16";break;case 3:e="U16";break;case 4:e="S32";break;case 5:e="U32";break;case 6:e="F32";break;case 7:e="F64";break;default:e="F32"}return e},isValidPixelValue:function(e,b){if(null==b)return!1;switch(e){case 0:e=-128<=b&&127>=b;break;case 1:e=0<=b&&255>=b;break;case 2:e=-32768<=b&&32767>=b;break;case 3:e=0<=b&&65536>=b;break;case 4:e=-2147483648<=b&&2147483647>=b;break;case 5:e=
0<=b&&4294967296>=b;break;case 6:e=-3.4027999387901484E38<=b&&3.4027999387901484E38>=b;break;case 7:e=4.9E-324<=b&&1.7976931348623157E308>=b;break;default:e=!1}return e},getDataTypeSize:function(e){var b=0;switch(e){case 0:case 1:b=1;break;case 2:case 3:b=2;break;case 4:case 5:case 6:b=4;break;case 7:b=8;break;default:b=e}return b},getDataTypeUsed:function(e,b){var d=e;switch(e){case 2:case 4:d=e-b;break;case 3:case 5:d=e-2*b;break;case 6:d=0===b?e:1===b?2:1;break;case 7:d=0===b?e:e-2*b+1;break;default:d=
e}return d},getOnePixel:function(e,b,d,g){e=0;switch(d){case 0:e=g.getInt8(b);break;case 1:e=g.getUint8(b);break;case 2:e=g.getInt16(b,!0);break;case 3:e=g.getUint16(b,!0);break;case 4:e=g.getInt32(b,!0);break;case 5:e=g.getUInt32(b,!0);break;case 6:e=g.getFloat32(b,!0);break;case 7:e=g.getFloat64(b,!0);break;default:throw"the decoder does not understand this pixel type";}return e},swapDimensionOrder:function(e,b,d,g,f){var h=0,n=0,m=0,k=0,q=e;if(1<d)if(q=new g(b*d),f)for(h=0;h<b;h++)for(k=h,m=0;m<
d;m++,k+=b)q[k]=e[n++];else for(h=0;h<b;h++)for(k=h,m=0;m<d;m++,k+=b)q[n++]=e[k];return q}},I=function(e,b,d){this.val=e;this.left=b;this.right=d};return{decode:function(e,b){b=b||{};var d=b.noDataValue,g=0,f={};f.ptr=b.inputOffset||0;f.pixels={};if(z.readHeaderInfo(e,f)){g=f.headerInfo;var h=g.fileVersion,n=z.getDataTypeArray(g.imageType);if(5<h)throw"unsupported lerc version 2."+h;z.readMask(e,f);g.numValidPixel===g.width*g.height||f.pixels.resultMask||(f.pixels.resultMask=b.maskData);var m=g.width*
g.height;f.pixels.resultPixels=new n(m*g.numDims);f.counter={onesweep:0,uncompressed:0,lut:0,bitstuffer:0,constant:0,constantoffset:0};var k=!b.returnPixelInterleavedDims;if(0!==g.numValidPixel)if(g.zMax===g.zMin)z.constructConstantSurface(f,k);else if(4<=h&&z.checkMinMaxRanges(e,f))z.constructConstantSurface(f,k);else{var q=new DataView(e,f.ptr,2),t=q.getUint8(0);f.ptr++;if(t)z.readDataOneSweep(e,f,n,k);else if(1<h&&1>=g.imageType&&1E-5>Math.abs(g.maxZError-.5)){q=q.getUint8(1);f.ptr++;f.encodeMode=
q;if(2<q||4>h&&1<q)throw"Invalid Huffman flag "+q;q?z.readHuffman(e,f,n,k):z.readTiles(e,f,n,k)}else z.readTiles(e,f,n,k)}f.eofOffset=f.ptr;b.inputOffset?(e=f.headerInfo.blobSize+b.inputOffset-f.ptr,1<=Math.abs(e)&&(f.eofOffset=b.inputOffset+f.headerInfo.blobSize)):(e=f.headerInfo.blobSize-f.ptr,1<=Math.abs(e)&&(f.eofOffset=f.headerInfo.blobSize));e={width:g.width,height:g.height,pixelData:f.pixels.resultPixels,minValue:g.zMin,maxValue:g.zMax,validPixelCount:g.numValidPixel,dimCount:g.numDims,dimStats:{minValues:g.minValues,
maxValues:g.maxValues},maskData:f.pixels.resultMask};if(f.pixels.resultMask&&z.isValidPixelValue(g.imageType,d)){h=f.pixels.resultMask;for(g=0;g<m;g++)h[g]||(e.pixelData[g]=d);e.noDataValue=d}f.noDataValue=d;b.returnFileInfo&&(e.fileInfo=z.formatFileInfo(f));return e}},getBandCount:function(e){for(var b=0,d=0,g={ptr:0,pixels:{}};d<e.byteLength-58;)z.readHeaderInfo(e,g),d+=g.headerInfo.blobSize,b++,g.ptr=d;return b}}})},"esri/layers/pixelFilters/VectorFieldPixelFilter":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../../kernel ../../lang dojo/_base/array".split(" "),
function(J,z,I,e,b,d){J=J(null,{declaredClass:"esri.layers.pixelFilters.VectorFieldPixelFilter",speedUnits:["esriMetersPerSecond","esriKilometersPerHour","esriKnots","esriFeetPerSecond","esriMilesPerHour"],constructor:function(g){z.mixin(this,g);this.isDataUV=g&&g.isDataUV?g.isDataUV:!1;this.computeMagnitudeAndDirection=z.hitch(this,this.computeMagnitudeAndDirection);this.unitConversionFactor=1;this._updateUnitConvFactor()},setUnits:function(g,f){this.inputUnit=g;this.outputUnit=f;this.unitConversionFactor=
1;this._updateUnitConvFactor()},_updateUnitConvFactor:function(){var g=d.indexOf(this.speedUnits,this.inputUnit),f=d.indexOf(this.speedUnits,this.outputUnit);if(this.inputUnit&&this.outputUnit&&0<=g&&0<=f){var h=[1,.277778,.514444,.3048,.44704,0];this.unitConversionFactor=h[g]/h[f]}},computeMagnitudeAndDirection:function(g){if(!b.isDefined(g))throw"Could not compute magnitude and direction. No pixel data is available.";var f=g.pixelBlock;if(!b.isDefined(f)||2!==f.getPlaneCount())throw"Could not compute magnitude and direction. Pixel data does not contain two bands.";
var h=g.extent,n=(h.xmax-h.xmin)/f.width,m=(h.ymax-h.ymin)/f.height,k=h.xmin+n/2;h=h.ymax-m/2;f.statistics[0].minValue=0;f.statistics[0].maxValue=0;var q=180/Math.PI,t=[],p=0,x=0,w=0,G=!b.isDefined(f.mask),M,S,R,O;var F=R=Infinity;var N=O=-Infinity;for(p=0;p<f.height;p++)for(x=0;x<f.width;x++,w++)if(t.push([k+n*x,h-m*p]),G||f.mask[w]){var K=M=f.pixels[0][w];var D=S=f.pixels[1][w];this.isDataUV&&(K=Math.sqrt(M*M+S*S),D=90-q*Math.atan2(S,M));f.pixels[0][w]=K*this.unitConversionFactor;f.pixels[1][w]=
D;K>N&&(N=K);K<F&&(F=K);D>O&&(O=D);D<R&&(R=D)}f.statistics[0].maxValue=N;f.statistics[0].minValue=F;f.statistics[1].maxValue=O;f.statistics[1].minValue=R;g.locations=t;return g}});I("extend-esri")&&z.setObject("layers.pixelFilters.VectorFieldPixelFilter",J,e);return J})},"esri/layers/rasterFormats/ImageCanvasDecoder":function(){define(["require","dojo/_base/declare","dojo/Deferred","dojo/sniff"],function(J,z,I,e){var b;return z(null,{constructor:function(d){this.ctx=d.ctx;this._loadRasterFormatModule()},
decode:function(d,g){if(!g.width||!g.height)throw"Native decoding requires the image format, width and height";var f=new I,h,n=new Uint8Array(d);d=this._getFormat(d);if("error"===d)throw"invalid format";"jpeg"===d&&(h=this._getMask(n,g));var m="",k;for(k=0;k<n.length;k+=65535){var q=n.subarray(k,k+65535>n.length-1?n.length-1:k+65535);m+=String.fromCharCode.apply(null,q)}n="data:image/"+d+";base64,"+window.btoa(m);var t=new Image,p;t.src=n;var x=this;t.onload=function(){x.ctx.clearRect(0,0,g.width,
g.height);x.ctx.drawImage(t,0,0);var w=x.ctx.getImageData(0,0,t.width,t.height);p=w.data;if(h)for(k=0;k<h.length;k++)p[4*k+3]=h[k]?255:0;x.ctx.putImageData(w,0,0);f.resolve(null)};t.onerror=function(){f.reject("cannot load image")};return f},_getFormat:function(d){d=new Uint8Array(d,0,10);var g="error";255===d[0]&&216===d[1]?g="jpeg":137===d[0]&&80===d[1]&&78===d[2]&&71===d[3]&&(g="png");return g},_getMask:function(d,g){try{if(!b)throw"The zlib decoder module is not loaded.";var f=0,h=0,n=Math.round(d.length/
2);1===n%2&&(n+=1);var m=d.length-2;for(f=n;f<m&&(255!==d[f]||217!==d[f+1]);f++);n=f+=2;if(n<d.length-1){var k=(new b(d.subarray(n))).getBytes();var q=new Uint8Array(g.width*g.height);for(f=d=0;f<k.length;f++)for(h=7;0<=h;h--)q[d++]=k[f]>>h&1}}catch(t){}return q},_loadRasterFormatModule:function(){10>e("ie")||J(["./Zlib"],function(d){b=d})}})})},"esri/tasks/ImageServiceIdentifyTask":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../request ../geometry/normalizeUtils ./Task ./ImageServiceIdentifyResult".split(" "),
function(J,z,I,e,b,d,g,f){J=J(g,{declaredClass:"esri.tasks.ImageServiceIdentifyTask",constructor:function(h){this._url.path+="/identify";this._handler=z.hitch(this,this._handler)},__msigns:[{n:"execute",c:3,a:[{i:0,p:["geometry"]}],e:2}],_handler:function(h,n,m,k,q){try{var t=new f(h);this._successHandler([t],"onComplete",m,q)}catch(p){this._errorHandler(p,k,q)}},execute:function(h,n,m,k){var q=k.assembly;h=this._encode(z.mixin({},this._url.query,{f:"json"},h.toJson(q&&q[0])));var t=this._handler,
p=this._errorHandler;return b({url:this._url.path,content:h,callbackParamName:"callback",load:function(x,w){t(x,w,n,m,k.dfd)},error:function(x){p(x,m,k.dfd)}})},onComplete:function(){}});d._createWrappers(J);I("extend-esri")&&z.setObject("tasks.ImageServiceIdentifyTask",J,e);return J})},"esri/tasks/Task":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/json dojo/has ../kernel ../deferredUtils ../urlUtils ../Evented".split(" "),function(J,z,I,e,b,d,g,f){J=J(f,{declaredClass:"esri.tasks._Task",
_eventMap:{error:["error"],complete:["result"]},constructor:function(h,n){h&&z.isString(h)&&(this._url=g.urlToObject(this.url=h));n&&n.requestOptions&&(this.requestOptions=n.requestOptions);this.normalization=!0;this._errorHandler=z.hitch(this,this._errorHandler);this.registerConnectEvents()},_useSSL:function(){var h=this._url,n=/^http:/i;this.url&&(this.url=this.url.replace(n,"https:"));h&&h.path&&(h.path=h.path.replace(n,"https:"))},_encode:function(h,n,m){var k={},q;for(q in h)if("declaredClass"!==
q){var t=h[q];var p=typeof t;if(null!==t&&void 0!==t&&"function"!==p)if(z.isArray(t)){k[q]=[];var x=t.length;for(p=0;p<x;p++)k[q][p]=this._encode(t[p])}else"object"===p?t.toJson&&(p=t.toJson(m&&m[q]),"esri.tasks.FeatureSet"===t.declaredClass&&p.spatialReference&&(p.sr=p.spatialReference,delete p.spatialReference),k[q]=n?p:I.toJson(p)):k[q]=t}return k},_successHandler:function(h,n,m,k){n&&this[n].apply(this,h);m&&m.apply(null,h);k&&d._resDfd(k,h)},_errorHandler:function(h,n,m){this.onError(h);n&&n(h);
m&&m.errback(h)},setNormalization:function(h){this.normalization=h},onError:function(){}});e("extend-esri")&&(b.Task=J);return J})},"esri/tasks/ImageServiceIdentifyResult":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../geometry/jsonUtils ./FeatureSet".split(" "),function(J,z,I,e,b,d){J=J(null,{declaredClass:"esri.tasks.ImageServiceIdentifyResult",constructor:function(g){g.catalogItems&&(this.catalogItems=new d(g.catalogItems));g.location&&(this.location=b.fromJson(g.location));
this.catalogItemVisibilities=g.catalogItemVisibilities;this.name=g.name;this.objectId=g.objectId;this.value=g.value;this.processedValues=g.processedValues;this.properties=g.properties}});I("extend-esri")&&z.setObject("tasks.ImageServiceIdentifyResult",J,e);return J})},"esri/tasks/FeatureSet":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../lang ../graphic ../SpatialReference ../graphicsUtils ../geometry/Polygon ../geometry/jsonUtils ../symbols/jsonUtils".split(" "),
function(J,z,I,e,b,d,g,f,h,n,m,k){J=J(null,{declaredClass:"esri.tasks.FeatureSet",constructor:function(q,t){if(q){z.mixin(this,q);var p=this.features=this.features||[],x=q.spatialReference;x=this.spatialReference=m.createInstance(f.simpleConstructor,x);var w=m.getGeometryType(q.geometryType);this.geometryType=q.geometryType;q.fields&&(this.fields=q.fields);q=m.supportsLazyUnquantization(this.geometryType);var G=m.unquantizeFunction(this.geometryType,this.transform),M=!!(t&&q&&G),S=w&&(M?w.accessorConstructor:
w.simpleConstructor);I.forEach(p,function(R,O){var F=m.createInstance(g.simpleConstructor),N=R.geometry;if(w&&N){var K=F.geometry=m.createInstance(S,M?null:N);K.setSpatialReference(N.spatialReference?m.createInstance(f.simpleConstructor,N.spatialReference):x);M&&K.setupLazyUnquantization(G,N)}F.symbol=R.symbol?k.fromJson(R.symbol):null;F.attributes=R.attributes;p[O]=F});M||this._hydrate()}else this.features=[]},displayFieldName:null,geometryType:null,spatialReference:null,fieldAliases:null,toJson:function(q){var t=
{};this.displayFieldName&&(t.displayFieldName=this.displayFieldName);this.fields&&(t.fields=this.fields);this.spatialReference?t.spatialReference=this.spatialReference.toJson():this.features[0]&&this.features[0].geometry&&(t.spatialReference=this.features[0].geometry.spatialReference.toJson());this.features[0]&&(this.features[0].geometry&&(t.geometryType=m.getJsonType(this.features[0].geometry)),t.features=h._encodeGraphics(this.features,q));t.geometryType=t.geometryType||this.geometryType;t.exceededTransferLimit=
this.exceededTransferLimit;t.transform=this.transform;return d.fixJson(t)},_hydrate:function(){m.unquantize(this.features,this.geometryType,this.transform);this.transform=null},quantize:function(q){if(!this.geometryType)return this.transform=null,this;var t=q.translate[0],p=q.translate[1],x=q.scale[0],w=q.scale[1],G=this.features,M=function(F,N,K){var D,Q=[];var r=0;for(D=F.length;r<D;r++){var v=F[r];if(0<r){var E=N(v[0]);v=K(v[1]);if(E!==H||v!==B){Q.push([E-H,v-B]);var H=E;var B=v}}else H=N(v[0]),
B=K(v[1]),Q.push([H,B])}return 0<Q.length?Q:null},S=function(F,N,K){if("esriGeometryPoint"===F)return function(D){D.x=N(D.x);D.y=K(D.y);return D};if("esriGeometryPolyline"===F||"esriGeometryPolygon"===F)return function(D){var Q;var r=D.rings||D.paths;var v=[];var E=0;for(Q=r.length;E<Q;E++){var H=r[E];(H=M(H,N,K))&&v.push(H)}return 0<v.length?(D.rings?D.rings=v:D.paths=v,D):null};if("esriGeometryMultipoint"===F)return function(D){var Q=M(D.points,N,K);return 0<Q.length?(D.points=Q,D):null};if("esriGeometryEnvelope"===
F)return function(D){return D}}(this.geometryType,function(F){return Math.round((F-t)/x)},function(F){return Math.round((p-F)/w)}),R;var O=0;for(R=G.length;O<R;O++)G[O].geometry&&(S(G[O].geometry)||G[O].setGeometry(null));this.transform=q;return this}});J.createGraphics=function(q){var t=q.geometryType,p=m.createInstance(f.simpleConstructor,q.spatialReference),x=m.getGeometryType(t).accessorConstructor,w=m.unquantizeFunction(t,q.transform);return I.map(q.features,function(G,M){M=m.createInstance(g.simpleConstructor);
var S=G.geometry;if(S){var R=M.geometry=m.createInstance(x);R.setSpatialReference(p);R.setupLazyUnquantization(w,S)}M.attributes=G.attributes;return M})};J.createPolygon=function(q,t,p){if(q){var x=m.createInstance(n.accessorConstructor);x.setSpatialReference(t);t=m.unquantizeFunction("esriGeometryPolygon",p);x.setupLazyUnquantization(t,q)}return x};e("extend-esri")&&z.setObject("tasks.FeatureSet",J,b);return J})},"esri/tasks/ImageServiceIdentifyParameters":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/json dojo/_base/array dojo/has ../kernel ../lang ../geometry/jsonUtils".split(" "),
function(J,z,I,e,b,d,g,f){J=J(null,{declaredClass:"esri.tasks.ImageServiceIdentifyParameters",geometry:null,mosaicRule:null,renderingRule:null,renderingRules:null,pixelSizeX:null,pixelSizeY:null,pixelSize:null,returnGeometry:!1,returnCatalogItems:!0,timeExtent:null,maxItemCount:null,returnPixelValues:!0,toJson:function(h){var n=h&&h.geometry||this.geometry;h={geometry:n,returnGeometry:this.returnGeometry,returnCatalogItems:this.returnCatalogItems,mosaicRule:this.mosaicRule?I.toJson(this.mosaicRule.toJson()):
null,renderingRule:this.renderingRule?I.toJson(this.renderingRule.toJson()):null};n&&(h.geometryType=f.getJsonType(n));n=this.timeExtent;h.time=n?n.toJson().join(","):null;g.isDefined(this.pixelSizeX)&&g.isDefined(this.pixelSizeY)?h.pixelSize=I.toJson({x:parseFloat(this.pixelSizeX),y:parseFloat(this.pixelSizeY)}):this.pixelSize&&(h.pixelSize=this.pixelSize?I.toJson(this.pixelSize.toJson()):null);this.renderingRules&&(h.renderingRules=I.toJson(e.map(this.renderingRules,function(m){return m.toJson()})));
g.isDefined(this.returnPixelValues)&&(h.returnPixelValues=this.returnPixelValues);g.isDefined(this.maxItemCount)&&(h.maxItemCount=this.maxItemCount);return h}});b("extend-esri")&&z.setObject("tasks.ImageServiceIdentifyParameters",J,d);return J})},"*noref":1}});
define("esri/layers/ArcGISImageServiceLayer","dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../config ./DynamicMapServiceLayer ./ImageServiceLayerMixin".split(" "),function(J,z,I,e,b,d,g){J=J([d,g],{declaredClass:"esri.layers.ArcGISImageServiceLayer",constructor:function(f,h){this._initialize(f,h);this.useMapImage=h&&h.useMapImage||!1},refresh:function(f){if(!0===f)this.inherited(arguments);else{var h=this.disableClientCaching;this.disableClientCaching=!0;this.inherited(arguments);this.disableClientCaching=
h}},setRenderer:function(f,h){this.renderer=f;this.onRendererChange();h||this.refresh(!0)},exportMapImage:function(f,h){var n=b.defaults.map;f=z.mixin({size:n.width+","+n.height},this._params,f?f.toJson(this.normalization):{},{f:"json"});delete f._ts;this._exportMapImage(this._url.path+"/exportImage",f,h)}});I("extend-esri")&&z.setObject("layers.ArcGISImageServiceLayer",J,e);return J});